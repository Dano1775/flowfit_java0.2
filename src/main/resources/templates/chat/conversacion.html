<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - FlowFit</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- FlowFit CSS System -->
  <link th:href="@{/css/flowfit-base.css}" rel="stylesheet">
  <link th:href="@{/css/flowfit-usuario.css}" rel="stylesheet" th:if="${esUsuario}">
  <link th:href="@{/css/flowfit-entrenador.css}" rel="stylesheet" th:unless="${esUsuario}">
  
  <style>
    /* Variables de colores - Tema oscuro limpio */
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --border-color: #475569;
    }
    
    /* Colores espec铆ficos por rol */
    <th:block th:if="${esUsuario}">
    :root {
      --accent-color: #10b981;
      --accent-light: #34d399;
      --accent-shadow: rgba(16, 185, 129, 0.3);
    }
    </th:block>
    
    <th:block th:unless="${esUsuario}">
    :root {
      --accent-color: #1e40af;
      --accent-light: #3b82f6;
      --accent-shadow: rgba(30, 64, 175, 0.3);
    }
    </th:block>
    
    /* Override Bootstrap para tema oscuro */
    body {
      background: var(--bg-primary) !important;
    }
    
    .main-content {
      background: var(--bg-primary) !important;
    }
    
    .chat-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      width: 100%;
      margin: 0;
      background: var(--bg-primary);
      padding: 0;
    }
    
    /* Container de mensajes - Estilo oscuro minimalista */
    .mensajes-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 5%;
      background: var(--bg-secondary);
      border-radius: 0;
      margin-bottom: 0;
      border: none;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      min-height: 0;
    }
    
    .mensajes-container::-webkit-scrollbar {
      width: 6px;
    }
    .mensajes-container::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 10px;
    }
    .mensajes-container::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 10px;
    }
    
    /* Mensajes - Animaci贸n suave */
    .mensaje-item {
      display: flex;
      margin-bottom: 1.2rem;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(10px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    .mensaje-item.enviado {
      justify-content: flex-end;
    }
    
    /* Burbujas minimalistas - SIEMPRE VISIBLES */
    .mensaje-bubble {
      max-width: 65%;
      padding: 0.9rem 1.3rem;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Mensajes recibidos - fondo oscuro con borde */
    .mensaje-item.recibido .mensaje-bubble {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    /* Mensajes enviados - Fondo azul s贸lido SIEMPRE VISIBLE */
    .mensaje-item.enviado .mensaje-bubble {
      background: #2563eb !important;
      color: #ffffff !important;
      border: 1px solid #3b82f6 !important;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3) !important;
    }
    
    .mensaje-bubble p {
      margin: 0;
      line-height: 1.5;
      color: inherit;
    }
    
    .mensaje-bubble small {
      opacity: 0.85;
      font-size: 0.75rem;
      color: inherit;
    }
    
    /* Asegurar que el texto sea visible en mensajes enviados */
    .mensaje-item.enviado .mensaje-bubble p,
    .mensaje-item.enviado .mensaje-bubble small {
      color: #ffffff !important;
    }
    
    /* Mensajes del sistema */
    .mensaje-sistema {
      text-align: center;
      margin: 1.5rem 0;
    }
    
    .mensaje-sistema .badge {
      padding: 0.6rem 1.2rem;
      font-weight: 500;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 18px;
      font-size: 0.85rem;
    }
    
    /* Propuesta Card */
    .propuesta-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1.8rem;
      margin: 1.5rem 0;
      max-width: 500px;
    }
    
    .propuesta-card.enviada {
      margin-left: auto;
    }
    
    .propuesta-precio {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent-color);
      margin: 0.5rem 0;
    }
    
    /* Barra de entrada */
    .chat-input-area {
      background: var(--bg-primary);
      border: none;
      border-top: 1px solid var(--border-color);
      border-radius: 0;
      padding: 1rem 5%;
      flex-shrink: 0;
    }
    
    .chat-input-wrapper {
      display: flex;
      gap: 0.8rem;
      align-items: center;
    }
    
    .action-btn {
      padding: 0.7rem;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border-radius: 10px;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      height: 44px;
    }
    
    .action-btn:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }
    
    .action-btn i {
      font-size: 1.2rem;
    }
    
    .dropdown-toggle::after {
      display: none;
    }
    
    #mensajeInput {
      background: var(--bg-tertiary) !important;
      border: 1px solid var(--border-color) !important;
      color: var(--text-primary) !important;
      border-radius: 10px;
      padding: 0.7rem 1rem;
      transition: all 0.2s ease;
      flex: 1;
      height: 44px;
    }
    
    #mensajeInput:focus {
      border-color: var(--accent-color) !important;
      background: var(--bg-secondary) !important;
      box-shadow: none !important;
      outline: none !important;
    }
    
    #mensajeInput::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }
    
    /* File Preview Styles */
    #filePreview {
      padding: 0.5rem 0;
      background: transparent;
    }
    
    .file-preview-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.6rem 1rem;
    }
    
    .file-preview-item img {
      max-width: 80px;
      max-height: 80px;
      border-radius: 6px;
      object-fit: cover;
    }
    
    .file-preview-item video {
      max-width: 120px;
      max-height: 80px;
      border-radius: 6px;
    }
    
    .file-preview-info {
      flex: 1;
      min-width: 0;
    }
    
    .file-preview-name {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-preview-size {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
    
    .file-preview-remove {
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-preview-remove:hover {
      background: #dc3545;
      border-color: #dc3545;
      color: white;
    }
    
    /* Mensaje con archivo adjunto */
    .mensaje-archivo {
      background: transparent;
      max-width: 400px;
    }
    
    .mensaje-archivo img {
      max-width: 100%;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .mensaje-archivo img:hover {
      transform: scale(1.02);
    }
    
    .mensaje-archivo video {
      max-width: 100%;
      border-radius: 8px;
    }
    
    .archivo-documento {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    
    .archivo-documento i {
      font-size: 2rem;
      color: var(--accent-color);
    }
    
    .archivo-info {
      flex: 1;
      min-width: 0;
    }
    
    .archivo-nombre {
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .archivo-tamano {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }
    
    .btn-icon {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.7rem;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-icon:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }
    
    .btn-icon.btn-send {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }
    
    .btn-icon.btn-send:hover {
      background: #3a8eef;
      border-color: #3a8eef;
    } background: #3a8eef;
      transform: scale(1.05);
    }
    
    /* Escrow Badge */
    .escrow-badge {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .escrow-badge.retenido {
      border-color: #f5576c;
      background: rgba(245, 87, 108, 0.1);
    }
    
    .escrow-badge.esperando {
      border-color: var(--accent-blue);
      background: rgba(74, 158, 255, 0.1);
    }
    
    .escrow-badge.liberado {
      border-color: #43e97b;
      background: rgba(67, 233, 123, 0.1);
    }
    
    /* Header del chat */
    .chat-header {
      background: var(--bg-primary);
      border: none;
      border-bottom: 1px solid var(--border-color);
      border-radius: 0;
      padding: 1.2rem 5%;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    
    .chat-header h4 {
      color: var(--text-primary);
      margin: 0;
      font-size: 1.1rem;
    }
    
    .chat-header small {
      color: var(--text-secondary);
    }
    
    .btn-back {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s ease;
    }
    
    .btn-back:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }
    
    /* Botones */
    .btn-outline-secondary {
      background: var(--bg-tertiary);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }
    
    .btn-outline-secondary:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }
    
    /* Alert */
    .alert-info {
      background: var(--bg-tertiary);
      border: 1px solid var(--accent-blue);
      color: var(--text-primary);
    }
    
    /* Archivo/Imagen inputs ocultos */
    .file-input {
      display: none;
    }
    
    /* Dropdown menu oscuro */
    .dropdown-menu {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .dropdown-item {
      color: var(--text-secondary);
      border-radius: 8px;
      padding: 0.6rem 1rem;
      transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .dropdown-item i {
      width: 20px;
      text-align: center;
    }
    
    .dropdown-divider {
      border-color: var(--border-color);
    }
    
    /* Animaci贸n de spinner */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spin {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    
    /* Modal de propuesta */
    .modal-content {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-color);
      border-radius: 16px;
    }
    
    .modal-header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 1.5rem;
    }
    
    .modal-title {
      color: var(--text-primary);
      font-size: 1.3rem;
    }
    
    .modal-body {
      padding: 2rem;
    }
    
    .modal-footer {
      background: var(--bg-primary);
      border-top: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }
    
    .form-label {
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
      background: var(--bg-tertiary) !important;
      border: 1px solid var(--border-color) !important;
      color: var(--text-primary) !important;
      border-radius: 10px;
      padding: 0.75rem 1rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--accent-color) !important;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2) !important;
      background: var(--bg-secondary) !important;
    }
    
    .form-select option {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .btn-close-white {
      filter: brightness(1.5);
    }
    
    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
      background: var(--bg-tertiary);
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
      border: none;
      color: var(--text-primary);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent-color) 100%);
    }
    
    .btn-warning {
      background: #ffa500;
      border: none;
      color: var(--text-primary);
    }
    
    .btn-warning:hover {
      background: #ff8c00;
    }
    
    @media (max-width: 768px) {
      .mensaje-bubble {
        max-width: 85%;
      }
      .propuesta-card {
        max-width: 90%;
      }
      .escrow-badge {
        position: static;
        margin-bottom: 1rem;
      }
      .action-btn span {
        display: none;
      }
      .action-btn {
        padding: 0.5rem;
      }
      .chat-header {
        padding: 1rem 1.5rem;
      }
      .mensajes-container {
        padding: 1rem 1.5rem;
      }
      .chat-input-area {
        padding: 0.8rem 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Desktop Toggle (for collapse) -->
  <button class="sidebar-collapse-btn d-none d-md-flex" id="sidebarCollapseBtn" title="Contraer/Expandir Sidebar">
    <i class="bi bi-chevron-left"></i>
  </button>

  <!-- Mobile Toggle -->
  <button class="sidebar-toggle-base d-md-none" id="sidebarToggle" 
          th:classappend="${esUsuario} ? 'sidebar-toggle-usuario' : 'sidebar-toggle-entrenador'">
    <i class="bi bi-list fs-4"></i>
  </button>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay-base" id="sidebarOverlay"></div>

  <!-- FlowFit Sidebar -->
  <div th:replace="~{${esUsuario ? 'fragments/sidebar-usuario' : 'fragments/sidebar-entrenador'} :: sidebar}"></div>

  <!-- Main Content -->
  <main class="main-content-base fade-in-up">
    <div class="container-fluid p-0">
      
      <!-- Escrow Status Badge (si hay contrataci贸n activa) -->
      <div th:if="${contratacion != null && contratacion.pago != null}" 
           class="escrow-badge"
           th:classappend="${contratacion.pago.estadoEscrow.name() == 'RETENIDO' ? 'retenido' : 
                           (contratacion.pago.estadoEscrow.name() == 'LIBERADO' ? 'liberado' : 'esperando')}">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-shield-check fs-4"></i>
          <div>
            <div class="fw-bold">Estado del Pago</div>
            <small th:text="${contratacion.pago.estadoEscrow.name()}">RETENIDO</small>
          </div>
        </div>
      </div>
      
      <!-- Chat Container -->
      <div class="chat-container">
        
        <!-- Header del Chat -->
        <div class="chat-header">
          <a th:href="@{/chat}" class="btn-back">
            <i class="bi bi-arrow-left"></i>
          </a>
          <img src="/assets/perfil_default.png" class="rounded-circle" width="40" height="40" alt="Avatar">
          <div style="flex: 1;">
            <h4 class="mb-0">
              <span th:if="${esUsuario}" th:text="${conversacion.entrenador.nombre}">Entrenador</span>
              <span th:unless="${esUsuario}" th:text="${conversacion.usuario.nombre}">Usuario</span>
            </h4>
            <small>
              <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i>
              En l铆nea
            </small>
          </div>
          <div class="dropdown">
            <button class="btn-back" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="archivarConversacion()">
                <i class="bi bi-archive me-2"></i>Archivar
              </a></li>
            </ul>
          </div>
        </div>
        
        <!-- Mensajes -->
        <div class="mensajes-container" id="mensajesContainer">
          
          <div th:each="mensaje : ${mensajes}">
            
            <!-- Mensaje de Sistema -->
            <div th:if="${mensaje.tipoMensaje.name() == 'SISTEMA'}" class="mensaje-sistema">
              <span class="badge bg-secondary">
                <i class="bi bi-info-circle me-1"></i>
                <span th:text="${mensaje.contenido}">Mensaje del sistema</span>
              </span>
            </div>
            
            <!-- Mensaje de Propuesta -->
            <div th:if="${mensaje.tipoMensaje.name() == 'PROPUESTA_PLAN'}" 
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviada' : ''}"
                 style="margin: 1.5rem 0;">
              <div class="propuesta-card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 2px solid var(--accent-color); border-radius: 16px; padding: 1.8rem; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                  <div>
                    <h5 class="text-white mb-1" style="font-size: 1.4rem; font-weight: 600;">
                      <i class="bi bi-star-fill me-2" style="color: #fbbf24;"></i>
                      Propuesta de Plan
                    </h5>
                    <p class="text-white mb-0" style="opacity: 0.7; font-size: 0.9rem;">
                      Plan personalizado para ti
                    </p>
                  </div>
                  <span class="badge" style="background: var(--accent-color); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem;" th:if="${mensaje.metadata != null}">
                    <i class="bi bi-layer-forward me-1"></i>
                    <span th:text="'V' + ${mensaje.metadata.get('version')}">v1</span>
                  </span>
                </div>
                
                <!-- Contenido Principal -->
                <div class="row g-3 mb-4">
                  <!-- Precio Destacado -->
                  <div class="col-12">
                    <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color);">
                      <div class="d-flex align-items-center justify-content-between">
                        <div>
                          <small class="text-white" style="opacity: 0.6; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Precio</small>
                          <div class="d-flex align-items-baseline mt-1">
                            <span style="font-size: 2.5rem; font-weight: 700; color: var(--accent-color);">
                              $<span th:text="${mensaje.metadata != null ? #numbers.formatDecimal(mensaje.metadata.get('precioFinal'), 0, 'COMMA', 0, 'POINT') : '0'}">50.000</span>
                            </span>
                            <span class="text-white ms-2" style="opacity: 0.7; font-size: 1rem;">COP</span>
                          </div>
                        </div>
                        <div class="text-end">
                          <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">Duraci贸n</small>
                          <div class="text-white mt-1" style="font-size: 1.2rem; font-weight: 600;" th:if="${mensaje.metadata != null && mensaje.metadata.get('duracionDias') != null}">
                            <i class="bi bi-calendar3 me-1" style="color: var(--accent-color);"></i>
                            <span th:text="${mensaje.metadata.get('duracionDias')}">30</span> d铆as
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Plan Info -->
                  <div class="col-md-12" th:if="${mensaje.metadata != null && mensaje.metadata.get('nombrePlan') != null}">
                    <div style="background: var(--bg-primary); border-radius: 10px; padding: 1rem; border-left: 4px solid var(--accent-color);">
                      <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                        <i class="bi bi-award me-1"></i>Plan incluido
                      </small>
                      <p class="text-white mb-0 mt-1" style="font-weight: 500;" th:text="${mensaje.metadata.get('nombrePlan')}">
                        Plan Premium
                      </p>
                    </div>
                  </div>
                </div>
                
                <!-- Comentarios -->
                <div class="mb-4" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty()}">
                  <small class="text-white" style="opacity: 0.6; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                    <i class="bi bi-chat-left-quote me-1"></i>Comentarios del entrenador
                  </small>
                  <p class="text-white mt-2 mb-0" style="font-size: 0.95rem; line-height: 1.6; background: var(--bg-primary); padding: 1rem; border-radius: 10px; border-left: 3px solid var(--accent-color);" th:text="${mensaje.contenido}">
                    Comentarios adicionales...
                  </p>
                </div>
                
                <!-- Botones de Acci贸n (Solo para el receptor) -->
                <div th:if="${mensaje.remitenteId != usuario.id}">
                  <div class="d-flex gap-2" th:if="${!esUsuario}">
                    <!-- Botones para Entrenador (cuando recibe contraoferta) -->
                    <button class="btn text-white flex-fill" 
                            style="background: #10b981; border: none; padding: 0.8rem; border-radius: 10px; font-weight: 500; transition: all 0.2s;"
                            th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                            onclick="aceptarPropuesta(this)"
                            onmouseover="this.style.background='#059669'"
                            onmouseout="this.style.background='#10b981'">
                      <i class="bi bi-check-circle-fill me-2"></i>Aceptar
                    </button>
                    <button class="btn text-dark flex-fill"
                            style="background: #fbbf24; border: none; padding: 0.8rem; border-radius: 10px; font-weight: 500; transition: all 0.2s;"
                            th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalContraoferta"
                            onmouseover="this.style.background='#f59e0b'"
                            onmouseout="this.style.background='#fbbf24'">
                      <i class="bi bi-arrow-left-right me-2"></i>Contraoferta
                    </button>
                  </div>
                  
                  <div th:if="${esUsuario}">
                    <!-- Botones para Usuario -->
                    <div class="d-flex gap-2">
                      <!-- Solo mostrar Aceptar si NO soy el remitente (la propuesta viene del entrenador) -->
                      <button th:if="${mensaje.remitenteId != usuario.id}" 
                              class="btn text-white flex-fill" 
                              style="background: #10b981; border: none; padding: 0.8rem; border-radius: 10px; font-weight: 500; transition: all 0.2s;"
                              th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                              onclick="aceptarPropuesta(this)"
                              onmouseover="this.style.background='#059669'"
                              onmouseout="this.style.background='#10b981'">
                        <i class="bi bi-check-circle-fill me-2"></i>Aceptar y Pagar
                      </button>
                      <!-- Solo mostrar Contraoferta si NO soy el remitente -->
                      <button th:if="${mensaje.remitenteId != usuario.id}"
                              class="btn text-dark flex-fill"
                              style="background: #fbbf24; border: none; padding: 0.8rem; border-radius: 10px; font-weight: 500; transition: all 0.2s;"
                              th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                              data-bs-toggle="modal" 
                              data-bs-target="#modalContraoferta"
                              onmouseover="this.style.background='#f59e0b'"
                              onmouseout="this.style.background='#fbbf24'">
                        <i class="bi bi-arrow-left-right me-2"></i>Hacer Contraoferta
                      </button>
                      <!-- Mensaje si es mi propia propuesta -->
                      <div th:if="${mensaje.remitenteId == usuario.id}"
                           class="propuesta-estado-usuario"
                           th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                           style="width: 100%; text-align: center; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; color: #fbbf24;">
                        <i class="bi bi-clock-history me-2"></i>
                        <strong>Esperando respuesta del entrenador</strong>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Mensaje cuando es mi propia propuesta (Entrenador) -->
                <div th:if="${mensaje.remitenteId == usuario.id && !esUsuario}">
                  <div style="width: 100%; text-align: center; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; color: #fbbf24;">
                    <i class="bi bi-clock-history me-2"></i>
                    <strong>Esperando respuesta del usuario</strong>
                  </div>
                </div>
                
                <!-- Timestamp -->
                <div class="text-end mt-3">
                  <small class="text-white" style="opacity: 0.5; font-size: 0.8rem;">
                    <i class="bi bi-clock me-1"></i>
                    <span th:text="${#temporals.format(mensaje.fechaEnvio, 'dd/MM/yyyy HH:mm')}">01/12/2024 10:30</span>
                  </small>
                </div>
                
              </div>
            </div>
            
            <!-- Mensaje con Imagen -->
            <div th:if="${mensaje.tipoMensaje.name() == 'IMAGEN'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <div class="mensaje-archivo">
                  <img th:src="${mensaje.archivoUrl}" 
                       th:alt="${mensaje.archivoNombre}"
                       onclick="window.open(this.src, '_blank')">
                  <p class="mb-1 mt-2" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty()}" 
                     th:text="${mensaje.contenido}"></p>
                </div>
                <small style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Mensaje con Archivo/Video -->
            <div th:if="${mensaje.tipoMensaje.name() == 'ARCHIVO'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <div class="mensaje-archivo">
                  <!-- Si es video -->
                  <div th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.startsWith('video/')}">
                    <video controls th:src="${mensaje.archivoUrl}">
                      Tu navegador no soporta el elemento de video.
                    </video>
                  </div>
                  <!-- Si es documento -->
                  <div th:if="${mensaje.archivoTipo == null || !mensaje.archivoTipo.startsWith('video/')}" 
                       class="archivo-documento">
                    <i class="bi bi-file-earmark-pdf" th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.contains('pdf')}"></i>
                    <i class="bi bi-file-earmark-word" th:if="${mensaje.archivoTipo != null && (mensaje.archivoTipo.contains('word') || mensaje.archivoTipo.contains('msword'))}"></i>
                    <i class="bi bi-file-earmark-excel" th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.contains('excel')}"></i>
                    <i class="bi bi-file-earmark-text" th:if="${mensaje.archivoTipo == null || (!mensaje.archivoTipo.contains('pdf') && !mensaje.archivoTipo.contains('word') && !mensaje.archivoTipo.contains('excel'))}"></i>
                    <div class="archivo-info">
                      <div class="archivo-nombre" th:text="${mensaje.archivoNombre}">documento.pdf</div>
                      <div class="archivo-tamano" th:text="${#numbers.formatDecimal(mensaje.archivoTamano / 1024.0, 1, 2)} + ' KB'">0 KB</div>
                    </div>
                    <a th:href="${mensaje.archivoUrl}" download class="btn btn-sm btn-primary">
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                  <p class="mb-0 mt-2" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty() && !mensaje.contenido.startsWith('')}" 
                     th:text="${mensaje.contenido}"></p>
                </div>
                <small style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Mensaje con Imagen -->
            <div th:if="${mensaje.tipoMensaje.name() == 'IMAGEN'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <div class="mensaje-archivo">
                  <img th:src="${mensaje.archivoUrl}" 
                       th:alt="${mensaje.archivoNombre}"
                       onclick="window.open(this.src, '_blank')">
                  <p class="mb-1 mt-2" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty() && !mensaje.contenido.startsWith('')}" 
                     th:text="${mensaje.contenido}"></p>
                </div>
                <small style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Mensaje con Archivo/Video -->
            <div th:if="${mensaje.tipoMensaje.name() == 'ARCHIVO'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <div class="mensaje-archivo">
                  <!-- Si es video -->
                  <div th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.startsWith('video/')}">
                    <video controls th:src="${mensaje.archivoUrl}">
                      Tu navegador no soporta el elemento de video.
                    </video>
                  </div>
                  <!-- Si es documento -->
                  <div th:if="${mensaje.archivoTipo == null || !mensaje.archivoTipo.startsWith('video/')}" 
                       class="archivo-documento">
                    <i class="bi bi-file-earmark-pdf" th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.contains('pdf')}"></i>
                    <i class="bi bi-file-earmark-word" th:if="${mensaje.archivoTipo != null && (mensaje.archivoTipo.contains('word') || mensaje.archivoTipo.contains('msword'))}"></i>
                    <i class="bi bi-file-earmark-excel" th:if="${mensaje.archivoTipo != null && mensaje.archivoTipo.contains('excel'))}"></i>
                    <i class="bi bi-file-earmark-text" th:if="${mensaje.archivoTipo == null || (!mensaje.archivoTipo.contains('pdf') && !mensaje.archivoTipo.contains('word') && !mensaje.archivoTipo.contains('excel'))}"></i>
                    <div class="archivo-info">
                      <div class="archivo-nombre" th:text="${mensaje.archivoNombre}">documento.pdf</div>
                      <div class="archivo-tamano" th:text="${#numbers.formatDecimal(mensaje.archivoTamano / 1024.0, 1, 2)} + ' KB'">0 KB</div>
                    </div>
                    <a th:href="${mensaje.archivoUrl}" download class="btn btn-sm btn-primary">
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                  <p class="mb-0 mt-2" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty() && !mensaje.contenido.startsWith('')}" 
                     th:text="${mensaje.contenido}"></p>
                </div>
                <small style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Mensaje Normal de Texto -->
            <div th:if="${mensaje.tipoMensaje.name() == 'TEXTO'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <p class="mb-1" th:text="${mensaje.contenido}">Contenido del mensaje</p>
                <small style="font-size: 0.75rem;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Confirmaci贸n de Servicio -->
            <div th:if="${mensaje.tipoMensaje.name() == 'CONFIRMACION_SERVICIO'}" class="mensaje-sistema">
              <span class="badge bg-success">
                <i class="bi bi-check-circle-fill me-1"></i>
                <span th:text="${mensaje.contenido}">Servicio confirmado</span>
              </span>
            </div>
            
            <!-- Disputa Iniciada -->
            <div th:if="${mensaje.tipoMensaje.name() == 'DISPUTA_INICIADA'}" class="mensaje-sistema">
              <span class="badge bg-danger">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                <span th:text="${mensaje.contenido}">Disputa iniciada</span>
              </span>
            </div>
            
          </div>
          
          <!-- Empty State -->
          <div th:if="${mensajes == null || #lists.isEmpty(mensajes)}" class="text-center py-5">
            <i class="bi bi-chat-dots text-muted-flowfit" style="font-size: 4rem; opacity: 0.3;"></i>
            <p class="text-muted-flowfit mt-3">No hay mensajes a煤n. 隆Inicia la conversaci贸n!</p>
          </div>
          
        </div>
        
        <!-- Botones de Confirmaci贸n de Escrow (si aplica) -->
        <div th:if="${contratacion != null && contratacion.pago != null && contratacion.pago.estadoEscrow.name() == 'RETENIDO'}"
             class="mb-3">
          <div class="alert alert-info d-flex align-items-center justify-content-between">
            <div>
              <i class="bi bi-shield-lock me-2"></i>
              <strong>Pago Protegido:</strong> El dinero est谩 retenido de forma segura.
            </div>
            <button class="btn btn-sm btn-success" 
                    th:attr="data-pago-id=${contratacion.pago.id}"
                    onclick="confirmarServicio(this)">
              <i class="bi bi-check-circle me-1"></i>
              Confirmar Servicio Recibido
            </button>
          </div>
        </div>
        
        <!-- Input de Mensaje Compacto -->
        <div class="chat-input-area">
          <!-- Preview de archivo -->
          <div id="filePreview" style="display: none;" class="mb-2"></div>
          
          <!-- Formulario de mensaje de texto -->
          <form id="formEnviarMensaje" th:action="@{/chat/enviar}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="conversacionId" th:value="${conversacion.id}">
            
            <!-- Inputs ocultos para archivos -->
            <input type="file" id="archivoInput" name="archivo" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display: none;" onchange="handleFileSelect(this)">
            
            <div class="chat-input-wrapper">
              <!-- Bot贸n de Archivos -->
              <button type="button" class="action-btn" onclick="document.getElementById('archivoInput').click()" title="Adjuntar archivo">
                <i class="bi bi-paperclip"></i>
              </button>

              <!-- Input de texto -->
              <input type="text" 
                     class="form-control" 
                     name="contenido"
                     id="mensajeInput"
                     placeholder="Escribe un mensaje..."
                     autocomplete="off">
              
              <!-- Bot贸n de Enviar Plan (solo entrenadores) -->
              <button type="button" class="btn-icon" th:unless="${esUsuario}" data-bs-toggle="modal" data-bs-target="#modalEnviarPropuesta" title="Enviar plan">
                <i class="bi bi-clipboard-check"></i>
              </button>
              
              <!-- Bot贸n de Enviar Mensaje -->
              <button class="btn-icon btn-send" type="submit" title="Enviar mensaje">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </form>
        </div>
        
      </div>
      
    </div>
  </main>
  
  <!-- Modal Enviar Propuesta (Solo Entrenadores) -->
  <!-- Modal Enviar Propuesta -->
  <div class="modal fade" id="modalEnviarPropuesta" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
          <div>
            <h5 class="modal-title fw-bold" style="color: var(--text-primary); font-size: 1.5rem; margin: 0;">
              <i class="bi bi-send-check me-2" style="color: var(--accent-color);"></i>Enviar Propuesta de Plan
            </h5>
            <p class="text-white mb-0 mt-1" style="font-size: 0.9rem; opacity: 0.7;">Selecciona un plan y personaliza la oferta</p>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="opacity: 0.7;"></button>
        </div>
        <form id="formEnviarPropuesta" onsubmit="enviarPropuesta(event)">
          <div class="modal-body" style="padding: 1.5rem;">
            
            <!-- Seleccionar Plan -->
            <div class="mb-4">
              <label class="form-label text-white fw-semibold mb-2">
                <i class="bi bi-clipboard-check me-2"></i>Plan Base
              </label>
              <select class="form-select text-white" name="planId" id="planSelect" required
                      style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px;">
                <option value="" style="background: var(--bg-tertiary);">-- Selecciona un plan --</option>
                <option th:each="plan : ${planesEntrenador}" 
                        th:value="${plan.id}"
                        th:attr="data-precio=${plan.precioMensual}, data-duracion=${plan.duracionDias}, data-nombre=${plan.nombre}"
                        th:text="${plan.nombre} + ' - $' + ${#numbers.formatDecimal(plan.precioMensual, 0, 'COMMA', 0, 'POINT')} + ' COP'"
                        style="background: var(--bg-tertiary);">
                </option>
              </select>
              <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                <i class="bi bi-info-circle me-1"></i>Tus planes disponibles para ofrecer
              </small>
            </div>
            
            <!-- Precio y Duraci贸n en fila -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label text-white fw-semibold mb-2">
                  <i class="bi bi-currency-dollar me-2"></i>Precio Final (COP)
                </label>
                <input type="number" class="form-control text-white" 
                       name="precioFinal" id="precioFinalInput" required min="0"
                       style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px;"
                       placeholder="0">
                <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                  <i class="bi bi-wallet2 me-1"></i>Ajusta seg煤n la negociaci贸n
                </small>
              </div>
              
              <div class="col-md-6">
                <label class="form-label text-white fw-semibold mb-2">
                  <i class="bi bi-calendar-range me-2"></i>Duraci贸n (d铆as)
                </label>
                <input type="number" class="form-control text-white" 
                       name="duracionDias" id="duracionInput" value="30" required min="1"
                       style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px;"
                       placeholder="30">
                <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                  <i class="bi bi-clock me-1"></i>Duraci贸n del servicio
                </small>
              </div>
            </div>
            
            <!-- Comentarios -->
            <div class="mb-3">
              <label class="form-label text-white fw-semibold mb-2">
                <i class="bi bi-chat-left-text me-2"></i>Comentarios Adicionales
              </label>
              <textarea class="form-control text-white" 
                        name="comentarios" id="comentariosInput" rows="4" 
                        style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px; resize: none;"
                        placeholder="Agrega detalles sobre esta propuesta, beneficios incluidos, etc..."></textarea>
              <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                <i class="bi bi-pencil me-1"></i>Opcional: Destaca lo que incluye tu oferta
              </small>
            </div>
            
          </div>
          <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1.5rem; gap: 0.8rem;">
            <button type="button" class="btn text-white" data-bs-dismiss="modal"
                    style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.6rem 1.5rem; border-radius: 10px; transition: all 0.2s;">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </button>
            <button type="submit" class="btn text-white"
                    style="background: var(--accent-color); border: 1px solid var(--accent-color); padding: 0.6rem 1.8rem; border-radius: 10px; font-weight: 500; transition: all 0.2s;">
              <i class="bi bi-send-fill me-2"></i>Enviar Propuesta
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Modal Contraoferta -->
  <div class="modal fade" id="modalContraoferta" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color); padding: 1.5rem;">
          <div>
            <h5 class="modal-title fw-bold" style="color: var(--text-primary); font-size: 1.3rem; margin: 0;">
              <i class="bi bi-arrow-repeat me-2" style="color: #ffc107;"></i>Hacer Contraoferta
            </h5>
            <p class="text-white mb-0 mt-1" style="font-size: 0.9rem; opacity: 0.7;">Prop贸n un precio alternativo</p>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" style="opacity: 0.7;"></button>
        </div>
        <form id="formContraoferta">
          <input type="hidden" name="contratacionId" id="contraofertaContratacionId">
          <div class="modal-body" style="padding: 1.5rem;">
            
            <div class="mb-4">
              <label class="form-label text-white fw-semibold mb-2">
                <i class="bi bi-currency-dollar me-2"></i>Nuevo Precio (COP)
              </label>
              <input type="number" class="form-control text-white" 
                     name="precioFinal" id="contraofertaPrecio" required min="0"
                     style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px;"
                     placeholder="Ingresa tu contraoferta">
              <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                <i class="bi bi-info-circle me-1"></i>Tu precio propuesto
              </small>
            </div>
            
            <div class="mb-3">
              <label class="form-label text-white fw-semibold mb-2">
                <i class="bi bi-chat-left-text me-2"></i>Comentarios
              </label>
              <textarea class="form-control text-white" 
                        name="comentarios" id="contraofertaComentarios" rows="4"
                        style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 10px; resize: none;"
                        placeholder="Explica tu contraoferta y por qu茅 consideras este precio..."></textarea>
              <small class="text-white" style="opacity: 0.6; font-size: 0.85rem;">
                <i class="bi bi-pencil me-1"></i>Opcional: Justifica tu propuesta
              </small>
            </div>
            
          </div>
          <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 1.5rem; gap: 0.8rem;">
            <button type="button" class="btn text-white" data-bs-dismiss="modal"
                    style="background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 0.6rem 1.5rem; border-radius: 10px;">
              <i class="bi bi-x-circle me-2"></i>Cancelar
            </button>
            <button type="submit" class="btn text-white"
                    style="background: #ffc107; border: 1px solid #ffc107; padding: 0.6rem 1.8rem; border-radius: 10px; font-weight: 500; color: #000 !important;">
              <i class="bi bi-arrow-repeat me-2"></i>Enviar Contraoferta
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- SockJS y STOMP para WebSocket -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  
  <!-- FlowFit Common JS -->
  <script th:src="@{/js/sidebar-common.js}"></script>
  
  <script>
    // Variables globales
    const conversacionId = [[${conversacion.id}]];
    const usuarioId = [[${usuario.id}]];
    const esUsuario = [[${esUsuario}]];
    let stompClient = null;
    
    // Auto-scroll al 煤ltimo mensaje
    function scrollToBottom() {
      const container = document.getElementById('mensajesContainer');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }
    
    // Scroll al cargar
    document.addEventListener('DOMContentLoaded', function() {
      scrollToBottom();
      conectarWebSocket();
    });
    
    // Conectar WebSocket
    function conectarWebSocket() {
      const socket = new SockJS('/ws-chat');
      stompClient = Stomp.over(socket);
      
      stompClient.connect({}, function(frame) {
        console.log('Conectado a WebSocket: ' + frame);
        
        // Suscribirse a mensajes de esta conversaci贸n
        stompClient.subscribe('/topic/conversacion/' + conversacionId, function(mensaje) {
          const data = JSON.parse(mensaje.body);
          
          // Si es notificaci贸n de propuesta aceptada, actualizar UI
          if (data.tipo === 'PROPUESTA_ACEPTADA') {
            actualizarPropuestaAceptada(data.contratacionId, data.mensaje, data.precioFinal);
          } else {
            agregarMensajeAlDOM(data);
          }
        });
      }, function(error) {
        console.error('Error WebSocket:', error);
        // Reintentar conexi贸n despu茅s de 5 segundos
        setTimeout(conectarWebSocket, 5000);
      });
    }
    
    // Agregar mensaje al DOM en tiempo real
    function agregarMensajeAlDOM(data) {
      const container = document.getElementById('mensajesContainer');
      const esEnviado = data.remitenteId === usuarioId;
      
      let contenidoHtml = '';
      
      // Si es una propuesta de plan
      if (data.tipoMensaje === 'PROPUESTA_PLAN' && data.metadata) {
        const metadata = typeof data.metadata === 'string' ? JSON.parse(data.metadata) : data.metadata;
        const precioFormateado = metadata.precioFinal ? metadata.precioFinal.toLocaleString('es-CO') : '0';
        
        contenidoHtml = `
          <div class="propuesta-plan-card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 2px solid var(--accent-color); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.3); max-width: 500px;">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.8rem;">
                <i class="bi bi-file-text-fill" style="font-size: 1.8rem; color: var(--accent-color);"></i>
                <div>
                  <div style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">Propuesta de Plan</div>
                  <div style="color: var(--text-secondary); font-size: 0.85rem;">Versi贸n ${metadata.version || 1}</div>
                </div>
              </div>
              <span style="background: var(--accent-color); color: #000; padding: 0.3rem 0.8rem; border-radius: 8px; font-weight: 600; font-size: 0.8rem;">
                v${metadata.version || 1}
              </span>
            </div>
            
            <!-- Precio y Duraci贸n -->
            <div style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px;">
              <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent-color); letter-spacing: -1px;">
                $${precioFormateado} <span style="font-size: 1rem; font-weight: 400;">COP</span>
              </div>
              <div style="color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.5rem;">
                <i class="bi bi-calendar-check me-1"></i>${metadata.duracionDias || 0} d铆as de entrenamiento
              </div>
            </div>
            
            <!-- Informaci贸n del Plan -->
            <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(0,0,0,0.15); border-left: 4px solid var(--accent-color); border-radius: 8px;">
              <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">
                <i class="bi bi-award me-2" style="color: var(--accent-color);"></i>${escapeHtml(metadata.nombrePlan || 'Plan Personalizado')}
              </div>
            </div>
            
            <!-- Comentarios -->
            ${data.contenido ? `
              <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 10px; background: rgba(0,0,0,0.1);">
                <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">
                  <i class="bi bi-chat-quote me-1"></i>Comentarios
                </div>
                <div style="color: var(--text-primary); line-height: 1.5; font-size: 0.95rem;">
                  ${escapeHtml(data.contenido)}
                </div>
              </div>
            ` : ''}
            
            <!-- Botones de Acci贸n -->
            ${esUsuario ? `
              ${data.remitenteId !== usuarioId ? `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                  <button onclick="aceptarPropuesta(${metadata.contratacionId})" 
                          style="background: #10b981; border: none; color: white; padding: 0.9rem; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#059669'" 
                          onmouseout="this.style.background='#10b981'">
                    <i class="bi bi-check-circle-fill me-2"></i>Aceptar y Pagar
                  </button>
                  <button onclick="abrirContraoferta(${metadata.contratacionId}, ${metadata.precioFinal})" 
                          style="background: #fbbf24; border: none; color: #000; padding: 0.9rem; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#f59e0b'" 
                          onmouseout="this.style.background='#fbbf24'">
                    <i class="bi bi-arrow-repeat me-2"></i>Contraoferta
                  </button>
                </div>
              ` : `
                <div class="propuesta-estado-usuario" data-contratacion-id="${metadata.contratacionId}" style="text-align: center; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; color: #fbbf24;">
                  <i class="bi bi-clock-history me-2"></i>
                  <strong>Esperando respuesta del entrenador</strong>
                </div>
              `}
            ` : `
              ${data.remitenteId !== usuarioId ? `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                  <button onclick="aceptarPropuesta(${metadata.contratacionId})" 
                          style="background: #10b981; border: none; color: white; padding: 0.8rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#059669'" 
                          onmouseout="this.style.background='#10b981'">
                    <i class="bi bi-check-circle me-1"></i>Aceptar
                  </button>
                  <button onclick="abrirContraoferta(${metadata.contratacionId}, ${metadata.precioFinal})" 
                          style="background: #fbbf24; border: none; color: #000; padding: 0.8rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.background='#f59e0b'" 
                          onmouseout="this.style.background='#fbbf24'">
                    <i class="bi bi-arrow-repeat me-1"></i>Contraoferta
                  </button>
                </div>
              ` : `
                <div style="text-align: center; padding: 1rem; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 10px; color: #fbbf24;">
                  <i class="bi bi-clock-history me-2"></i>
                  <strong>Esperando respuesta del usuario</strong>
                </div>
              `}
            `}
            
            <!-- Timestamp -->
            <div style="margin-top: 1rem; padding-top: 0.8rem; border-top: 1px solid var(--border-color); text-align: center;">
              <small style="color: var(--text-secondary); font-size: 0.8rem;">
                <i class="bi bi-clock me-1"></i>${formatearHora(data.fechaEnvio)}
              </small>
            </div>
          </div>
        `;
      }
      // Si es una imagen
      else if (data.tipoMensaje === 'IMAGEN' && data.archivoUrl) {
        contenidoHtml = `
          <div class="mensaje-archivo">
            <img src="${data.archivoUrl}" alt="${escapeHtml(data.archivoNombre || 'Imagen')}" 
                 onclick="window.open(this.src, '_blank')" style="max-width: 100%; border-radius: 8px; cursor: pointer;">
            ${data.contenido && !data.contenido.startsWith('') ? `<p class="mb-1 mt-2">${escapeHtml(data.contenido)}</p>` : ''}
          </div>`;
      }
      // Si es un archivo o video
      else if (data.tipoMensaje === 'ARCHIVO' && data.archivoUrl) {
        if (data.archivoTipo && data.archivoTipo.startsWith('video/')) {
          contenidoHtml = `
            <div class="mensaje-archivo">
              <video controls src="${data.archivoUrl}" style="max-width: 100%; border-radius: 8px;">
                Tu navegador no soporta el elemento de video.
              </video>
              ${data.contenido && !data.contenido.startsWith('') ? `<p class="mb-0 mt-2">${escapeHtml(data.contenido)}</p>` : ''}
            </div>`;
        } else {
          const iconClass = data.archivoTipo?.includes('pdf') ? 'bi-file-earmark-pdf' :
                           data.archivoTipo?.includes('word') ? 'bi-file-earmark-word' :
                           data.archivoTipo?.includes('excel') ? 'bi-file-earmark-excel' :
                           'bi-file-earmark-text';
          const tamanoKB = data.archivoTamano ? (data.archivoTamano / 1024).toFixed(2) : '0';
          
          contenidoHtml = `
            <div class="mensaje-archivo">
              <div class="archivo-documento">
                <i class="bi ${iconClass}" style="font-size: 2rem; color: var(--accent-color);"></i>
                <div class="archivo-info" style="flex: 1; min-width: 0;">
                  <div class="archivo-nombre" style="color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(data.archivoNombre || 'Archivo')}
                  </div>
                  <div class="archivo-tamano" style="color: var(--text-secondary); font-size: 0.75rem;">
                    ${tamanoKB} KB
                  </div>
                </div>
                <a href="${data.archivoUrl}" download class="btn btn-sm btn-primary">
                  <i class="bi bi-download"></i>
                </a>
              </div>
              ${data.contenido && !data.contenido.startsWith('') ? `<p class="mb-0 mt-2">${escapeHtml(data.contenido)}</p>` : ''}
            </div>`;
        }
      }
      // Mensaje de texto normal
      else {
        contenidoHtml = `<p class="mb-1">${escapeHtml(data.contenido)}</p>`;
      }
      
      const mensajeHTML = `
        <div class="mensaje-item ${esEnviado ? 'enviado' : 'recibido'}">
          <div class="mensaje-bubble" style="${data.tipoMensaje === 'PROPUESTA_PLAN' ? 'background: transparent; box-shadow: none; padding: 0;' : ''}">
            ${contenidoHtml}
            ${data.tipoMensaje !== 'PROPUESTA_PLAN' ? `
              <small style="font-size: 0.75rem; ${data.tipoMensaje !== 'TEXTO' ? 'margin-top: 0.5rem; display: block;' : ''}">
                ${formatearHora(data.fechaEnvio)}
              </small>
            ` : ''}
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', mensajeHTML);
      scrollToBottom();
    }
    
    // Formatear hora
    function formatearHora(fechaStr) {
      const fecha = new Date(fechaStr);
      return fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Escapar HTML para prevenir XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Variables para manejo de archivos
    let selectedFile = null;
    
    // Manejar selecci贸n de archivo
    function handleFileSelect(input) {
      const file = input.files[0];
      if (!file) return;
      
      selectedFile = file;
      
      // Validar tama帽o (50MB)
      if (file.size > 50 * 1024 * 1024) {
        alert('El archivo no puede superar los 50MB');
        input.value = '';
        selectedFile = null;
        return;
      }
      
      // Mostrar preview
      showFilePreview(file);
      
      // Hacer opcional el campo de texto cuando hay archivo
      document.getElementById('mensajeInput').removeAttribute('required');
    }
    
    // Mostrar preview del archivo
    function showFilePreview(file) {
      const preview = document.getElementById('filePreview');
      const fileSize = (file.size / 1024).toFixed(2);
      
      let previewContent = '';
      
      // Preview de imagen
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContent = `
            <div class="file-preview-item">
              <img src="${e.target.result}" alt="Preview">
              <div class="file-preview-info">
                <div class="file-preview-name">${file.name}</div>
                <div class="file-preview-size">${fileSize} KB</div>
              </div>
              <button type="button" class="file-preview-remove" onclick="removeFilePreview()">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          `;
          preview.innerHTML = previewContent;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
      // Preview de video
      else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewContent = `
            <div class="file-preview-item">
              <video src="${e.target.result}"></video>
              <div class="file-preview-info">
                <div class="file-preview-name">${file.name}</div>
                <div class="file-preview-size">${fileSize} KB</div>
              </div>
              <button type="button" class="file-preview-remove" onclick="removeFilePreview()">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          `;
          preview.innerHTML = previewContent;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
      // Preview de documento
      else {
        const iconClass = file.type.includes('pdf') ? 'bi-file-earmark-pdf' :
                         file.type.includes('word') ? 'bi-file-earmark-word' :
                         file.type.includes('excel') ? 'bi-file-earmark-excel' :
                         'bi-file-earmark-text';
        
        previewContent = `
          <div class="file-preview-item">
            <i class="bi ${iconClass}" style="font-size: 2rem; color: var(--accent-color);"></i>
            <div class="file-preview-info">
              <div class="file-preview-name">${file.name}</div>
              <div class="file-preview-size">${fileSize} KB</div>
            </div>
            <button type="button" class="file-preview-remove" onclick="removeFilePreview()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        `;
        preview.innerHTML = previewContent;
        preview.style.display = 'block';
      }
    }
    
    // Remover preview de archivo
    function removeFilePreview() {
      const preview = document.getElementById('filePreview');
      const fileInput = document.getElementById('archivoInput');
      
      preview.innerHTML = '';
      preview.style.display = 'none';
      fileInput.value = '';
      selectedFile = null;
      
      // Volver a requerir el campo de texto
      const mensajeInput = document.getElementById('mensajeInput');
      if (!selectedFile) {
        mensajeInput.setAttribute('required', 'required');
      }
    }
    
    // Interceptar el submit del formulario para enviar con FormData
    document.getElementById('formEnviarMensaje').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const contenido = document.getElementById('mensajeInput').value.trim();
      
      // Validar que haya contenido o archivo
      if (!contenido && !selectedFile) {
        alert('Escribe un mensaje o adjunta un archivo');
        return;
      }
      
      // Deshabilitar bot贸n de env铆o
      const btnEnviar = this.querySelector('button[type="submit"]');
      btnEnviar.disabled = true;
      
      fetch('/chat/enviar', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Limpiar formulario
          document.getElementById('mensajeInput').value = '';
          removeFilePreview();
        } else {
          alert(data.message || 'Error al enviar mensaje');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar mensaje');
      })
      .finally(() => {
        btnEnviar.disabled = false;
      });
    });
    
    // Ya NO necesitamos auto-refresh porque tenemos WebSocket
    // setInterval(() => { location.reload(); }, 10000); // ELIMINADO
    
    // Actualizar precio cuando se selecciona un plan
    document.getElementById('planSelect')?.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      const precio = selected.getAttribute('data-precio');
      const duracion = selected.getAttribute('data-duracion');
      
      document.getElementById('precioFinalInput').value = precio;
      document.getElementById('duracionInput').value = duracion;
    });
    
    // Aceptar propuesta
    function aceptarPropuesta(contratacionIdOrButton) {
      let contratacionId;
      
      // Soportar tanto el ID directo como un bot贸n
      if (typeof contratacionIdOrButton === 'object') {
        contratacionId = contratacionIdOrButton.getAttribute('data-contratacion-id');
      } else {
        contratacionId = contratacionIdOrButton;
      }
      
      console.log('Aceptando propuesta:', contratacionId);
      
      const mensajeConfirmacion = esUsuario 
        ? '驴Est谩s seguro de aceptar esta propuesta? Se proceder谩 al pago.'
        : '驴Est谩s seguro de aceptar esta contraoferta del usuario?';
      
      if (confirm(mensajeConfirmacion)) {
        // Mostrar loading
        const btnAceptar = document.querySelector(`button[onclick*="aceptarPropuesta(${contratacionId})"]`);
        if (btnAceptar) {
          btnAceptar.disabled = true;
          btnAceptar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
        }
        
        fetch('/negociacion/responder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contratacionId: parseInt(contratacionId),
            accion: 'ACEPTAR'
          })
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            // Solo redirigir al pago si es USUARIO
            if (esUsuario) {
              window.location.href = '/negociacion/generar-pago?contratacionId=' + contratacionId;
            } else {
              // Si es entrenador, mostrar mensaje de 茅xito y recargar chat
              alert('Contraoferta aceptada. El usuario recibir谩 notificaci贸n para proceder al pago.');
              location.reload();
            }
          } else {
            alert(data.message || 'Error al aceptar la propuesta');
            if (btnAceptar) {
              btnAceptar.disabled = false;
              const textoBoton = esUsuario ? 'Aceptar y Pagar' : 'Aceptar';
              btnAceptar.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>' + textoBoton;
            }
          }
        })
        .catch(error => {
          console.error('Error completo:', error);
          alert('Error al procesar la solicitud: ' + error.message);
          if (btnAceptar) {
            btnAceptar.disabled = false;
            const textoBoton = esUsuario ? 'Aceptar y Pagar' : 'Aceptar';
            btnAceptar.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>' + textoBoton;
          }
        });
      }
    }
    
    // Actualizar UI cuando el entrenador acepta la contraoferta del usuario
    function actualizarPropuestaAceptada(contratacionId, mensaje, precioFinal) {
      console.log('Actualizando propuesta aceptada:', contratacionId);
      
      // Buscar el div de estado de la propuesta en Thymeleaf
      const estadoDiv = document.querySelector(`.propuesta-estado-usuario[data-contratacion-id="${contratacionId}"]`);
      
      if (estadoDiv) {
        estadoDiv.style.background = 'rgba(16, 185, 129, 0.1)';
        estadoDiv.style.borderColor = '#10b981';
        estadoDiv.style.color = '#10b981';
        estadoDiv.innerHTML = `
          <div style="margin-bottom: 0.8rem;">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>隆Propuesta Aceptada!</strong>
          </div>
          <button onclick="window.location.href='/negociacion/generar-pago?contratacionId=${contratacionId}'" 
                  style="background: #10b981; border: none; color: white; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s;"
                  onmouseover="this.style.background='#059669'" 
                  onmouseout="this.style.background='#10b981'">
            <i class="bi bi-credit-card me-2"></i>Pagar con MercadoPago - $${precioFinal}
          </button>
        `;
      }
      
      // Tambi茅n buscar en los mensajes din谩micos (si fue contraoferta del usuario)
      const mensajesContainer = document.getElementById('mensajesContainer');
      if (mensajesContainer) {
        const esperandoDivs = mensajesContainer.querySelectorAll('div[style*="Esperando respuesta del entrenador"]');
        esperandoDivs.forEach(div => {
          const parentCard = div.closest('.propuesta-card, [style*="rgba(30, 41, 59"]');
          if (parentCard && parentCard.textContent.includes('$' + precioFinal)) {
            div.style.background = 'rgba(16, 185, 129, 0.1)';
            div.style.borderColor = '#10b981';
            div.style.color = '#10b981';
            div.innerHTML = `
              <div style="margin-bottom: 0.8rem;">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>隆Propuesta Aceptada!</strong>
              </div>
              <button onclick="window.location.href='/negociacion/generar-pago?contratacionId=${contratacionId}'" 
                      style="background: #10b981; border: none; color: white; padding: 0.8rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s;"
                      onmouseover="this.style.background='#059669'" 
                      onmouseout="this.style.background='#10b981'">
                <i class="bi bi-credit-card me-2"></i>Pagar con MercadoPago - $${precioFinal}
              </button>
            `;
          }
        });
      }
      
      // Mostrar notificaci贸n toast
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: '隆Propuesta Aceptada!',
          text: mensaje,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 4000
        });
      }
    }
    
    // Rechazar propuesta
    function rechazarPropuesta(contratacionIdOrButton) {
      let contratacionId;
      
      // Soportar tanto el ID directo como un bot贸n
      if (typeof contratacionIdOrButton === 'object') {
        contratacionId = contratacionIdOrButton.getAttribute('data-contratacion-id');
      } else {
        contratacionId = contratacionIdOrButton;
      }
      
      console.log('Rechazando propuesta:', contratacionId);
      
      if (confirm('驴Est谩s seguro de rechazar esta propuesta? Esta acci贸n no se puede deshacer.')) {
        fetch('/negociacion/responder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contratacionId: parseInt(contratacionId),
            accion: 'RECHAZAR'
          })
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            // Ocultar los botones de la propuesta rechazada
            const botonesDiv = document.querySelector(`button[onclick*="rechazarPropuesta(${contratacionId})"]`)?.closest('div[style*="grid"], div[style*="flex"]');
            if (botonesDiv) {
              botonesDiv.innerHTML = '<div style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 10px; color: #ef4444; font-weight: 600;"><i class="bi bi-x-circle me-2"></i>Propuesta Rechazada</div>';
            }
            
            alert('Propuesta rechazada. Puedes continuar conversando para ajustar t茅rminos.');
          } else {
            alert(data.message || 'Error al rechazar la propuesta');
          }
        })
        .catch(error => {
          console.error('Error completo:', error);
          alert('Error al procesar la solicitud: ' + error.message);
        });
      }
    }
    
    // Abrir modal de contraoferta
    function abrirContraoferta(contratacionId, precioActual) {
      document.getElementById('contraofertaContratacionId').value = contratacionId;
      if (precioActual) {
        document.getElementById('contraofertaPrecio').value = precioActual;
      }
      const modal = new bootstrap.Modal(document.getElementById('modalContraoferta'));
      modal.show();
    }
    
    // Preparar contraoferta
    document.querySelectorAll('[data-bs-target="#modalContraoferta"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const contratacionId = this.getAttribute('data-contratacion-id');
        document.getElementById('contraofertaContratacionId').value = contratacionId;
      });
    });
    
    // Enviar contraoferta
    document.getElementById('formContraoferta').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const contratacionId = document.getElementById('contraofertaContratacionId').value;
      const precio = document.getElementById('contraofertaPrecio').value;
      const comentarios = document.getElementById('contraofertaComentarios').value;
      
      console.log('=== ENVIANDO CONTRAOFERTA ===');
      console.log('ContratacionId:', contratacionId);
      console.log('Precio:', precio);
      console.log('Comentarios:', comentarios);
      
      // Construir propuesta completa con todos los campos necesarios
      const propuesta = {
        precio: parseFloat(precio),
        duracionDias: 30, // Valor por defecto
        rutinasMes: 4,
        seguimientoSemanal: true,
        videollamadasMes: 0,
        planNutricional: false,
        chatDirecto: true,
        mensaje: comentarios || ''
      };
      
      const requestBody = {
        contratacionId: parseInt(contratacionId),
        accion: 'CONTRAOFERTA',
        propuesta: propuesta
      };
      
      console.log('Request body:', JSON.stringify(requestBody, null, 2));
      
      // Deshabilitar bot贸n
      const btnSubmit = this.querySelector('button[type="submit"]');
      if (btnSubmit) {
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
      }
      
      fetch('/negociacion/responder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          alert(data.message || 'Contraoferta enviada correctamente');
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalContraoferta'));
          if (modal) modal.hide();
          // No recargar, el WebSocket deber铆a actualizar
          // location.reload();
        } else {
          alert(data.message || 'Error al enviar contraoferta');
          if (btnSubmit) {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Enviar Contraoferta';
          }
        }
      })
      .catch(error => {
        console.error('Error completo:', error);
        alert('Error al procesar la solicitud: ' + error.message);
        if (btnSubmit) {
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Enviar Contraoferta';
        }
      });
    });
    
    // Confirmar servicio (Escrow)
    function confirmarServicio(button) {
      const pagoId = button.getAttribute('data-pago-id');
      if (confirm('驴Confirmas que has recibido/entregado el servicio correctamente?')) {
        const esUsuario = [[${esUsuario}]];
        const endpoint = esUsuario ? '/negociacion/confirmar-servicio/usuario' : '/negociacion/confirmar-servicio/entrenador';
        
        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ pagoId: pagoId })
        })
        .then(response => response.json())
        .then(data => {
          alert(data.mensaje || 'Confirmaci贸n registrada');
          location.reload();
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al confirmar el servicio');
        });
      }
    }
    
    // Focus en input al cargar
    document.getElementById('mensajeInput')?.focus();
    
    // Funci贸n para enviar propuesta
    function enviarPropuesta(event) {
      event.preventDefault();
      
      const form = event.target;
      const planBaseId = document.getElementById('planSelect').value;
      const precio = document.getElementById('precioFinalInput').value;
      const duracionDias = document.getElementById('duracionInput').value;
      const mensaje = document.getElementById('comentariosInput').value;

      const propuesta = {
        planBaseId: planBaseId ? parseInt(planBaseId) : null,
        precio: precio ? parseFloat(precio) : null,
        duracionDias: duracionDias ? parseInt(duracionDias) : null,
        mensaje: mensaje || ""
      };
      
      fetch('/negociacion/enviar-propuesta?conversacionId=' + conversacionId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(propuesta)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Propuesta enviada exitosamente');
          bootstrap.Modal.getInstance(document.getElementById('modalEnviarPropuesta')).hide();
          location.reload();
        } else {
          alert('Error: ' + (data.message || 'No se pudo enviar la propuesta'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la propuesta');
      });
    }
    
    // Auto-completar precio cuando se selecciona un plan
    document.getElementById('planSelect')?.addEventListener('change', function() {
      const option = this.options[this.selectedIndex];
      if (option.value) {
        const precio = option.getAttribute('data-precio');
        const duracion = option.getAttribute('data-duracion');
        document.getElementById('precioFinalInput').value = precio;
        document.getElementById('duracionInput').value = duracion;
      }
    });
    
    // Funci贸n para enviar archivos (placeholder - requiere implementaci贸n backend)
    function enviarArchivo(input, tipo) {
      const file = input.files[0];
      if (!file) return;
      
      // Validar tama帽o (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('El archivo es demasiado grande. M谩ximo 10MB.');
        input.value = '';
        return;
      }
      
      // Mostrar mensaje de "Subiendo..."
      const container = document.getElementById('mensajesContainer');
      const loadingHTML = `
        <div class="mensaje-item enviado" id="uploading-message">
          <div class="mensaje-bubble">
            <p class="mb-1 text-white">
              <i class="bi bi-arrow-repeat spin"></i> Subiendo ${tipo}...
            </p>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', loadingHTML);
      scrollToBottom();
      
      // TODO: Implementar upload de archivos al backend
      // Por ahora solo mostramos un mensaje simulado
      setTimeout(() => {
        document.getElementById('uploading-message')?.remove();
        const mensajeSimulado = {
          remitenteId: usuarioId,
          contenido: ` ${file.name} (${(file.size / 1024).toFixed(1)} KB)`,
          fechaEnvio: new Date().toISOString()
        };
        agregarMensajeAlDOM(mensajeSimulado);
        input.value = ''; // Limpiar input
        
        alert('Funci贸n de subida de archivos pr贸ximamente. Por ahora solo texto.');
      }, 1500);
    }
  </script>
</body>
</html>
