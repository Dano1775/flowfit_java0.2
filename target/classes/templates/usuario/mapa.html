<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa - FlowFit</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link th:href="@{/css/flowfit-base.css}" rel="stylesheet">
  <link th:href="@{/css/flowfit-usuario.css}" rel="stylesheet">
  <link th:href="@{/css/usuario-mapa.css}" rel="stylesheet">
</head>
<body class="flowfit-body usuario-body">

  <!-- Sidebar -->
  <div th:replace="fragments/sidebar-user :: sidebar"></div>
  <div class="flowfit-sidebar-overlay d-lg-none" id="sidebarOverlay"></div>
  <button class="flowfit-sidebar-toggle sidebar-toggle-usuario d-lg-none" id="sidebarToggle">
    <i class="bi bi-list"></i>
  </button>

  <main class="main-content-base fade-in-up">
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-12">
          <div class="flowfit-page-header">
            <div class="flowfit-page-title">
              <h1 class="flowfit-title"><i class="bi bi-geo-alt me-2"></i>Mapa</h1>
              <p class="flowfit-subtitle">Ubicación y puntos de interés</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="flowfit-card card-usuario">
            <div class="card-header">
              <h5 class="card-title mb-0 text-white"><i class="bi bi-map me-2"></i>Mapa</h5>
            </div>
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script th:src="@{/js/usuario-mapa.js}"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDaeWicvigtP9xPv919E-RNoxfvC-Hqik&callback=iniciarMap" async defer></script>
  <!-- Leaflet (fallback si Google Maps no responde) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+4g3o7wqv1z7Zqk3gYh6b0gk2Xc8HkG6v9YlP5R0M=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-Vt6v7Y6m3yqTeKc3Nf0vYq0Q1s5dYt1K8lM8Yw5gk8M=" crossorigin=""></script>

  <script>
    // Si Google Maps no llama a iniciarMap en 8s, cargamos Leaflet como fallback
    (function(){
      var timeout = setTimeout(function(){
        if(!(window.google && window.google.maps && window.google.maps.Map)){
          console.warn('Google Maps no cargó, usando Leaflet como fallback.');
          // Inicializar mapa Leaflet
          var mapEl = document.getElementById('map');
          if(mapEl){
            // Limpiar contenido previo
            mapEl.innerHTML = '';
            mapEl.style.height = mapEl.style.height || '500px';
            var map = L.map('map').setView([4.6518757, -74.0629621], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([4.6518757, -74.0629621]).addTo(map).bindPopup('Ubicación por defecto').openPopup();
          }
        }
      }, 8000);

      // Si Google llama a iniciarMap cancelamos el timeout
      var orig = window.iniciarMap;
      window.iniciarMap = function(){
        clearTimeout(timeout);
        if(typeof orig === 'function') orig();
      }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>