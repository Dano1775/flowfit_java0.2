<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crear Ejercicio - FlowFit Coach</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link th:href="@{/css/entrenador-dashboard.css}" rel="stylesheet">
  
  <!-- Custom FlowFit VIP Styles -->
  <style>
    /* === FLOWFIT VIP ENTRENADOR THEME === */
    
    .create-form-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      margin-bottom: 2rem;
    }
    
    .form-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .form-title {
      color: #ffffff;
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .form-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
      margin-bottom: 0;
    }
    
    .form-group-custom {
      margin-bottom: 1.5rem;
    }
    
    .form-label-custom {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      font-size: 0.95rem;
    }
    
    .form-label-custom i {
      color: rgba(59, 130, 246, 0.8);
      margin-right: 0.5rem;
      font-size: 1rem;
    }
    
    .form-control-custom {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 0.875rem 1.25rem;
      color: #ffffff;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      resize: vertical;
    }
    
    .form-control-custom:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
      outline: none;
      color: #ffffff;
    }
    
    .form-control-custom::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .file-upload-area {
      position: relative;
      background: rgba(255, 255, 255, 0.05);
      border: 2px dashed rgba(59, 130, 246, 0.5);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .file-upload-area:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(59, 130, 246, 0.7);
    }
    
    .file-upload-area.dragover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.8);
    }
    
    .file-upload-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      transition: all 0.3s ease;
    }
    
    .file-upload-icon i {
      font-size: 1.5rem;
      color: #ffffff;
    }
    
    .file-upload-text {
      color: #ffffff;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .file-upload-hint {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.875rem;
    }
    
    .file-input-hidden {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    
    .image-preview-container {
      display: none;
      margin-top: 1rem;
      text-align: center;
    }
    
    .image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 16px;
      padding: 0.875rem 2rem;
      font-weight: 600;
      font-size: 1rem;
      color: #ffffff;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
      width: 100%;
    }
    
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(16, 185, 129, 0.4);
      color: #ffffff;
    }
    
    .btn-secondary-custom {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 0.875rem 2rem;
      font-weight: 600;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      width: 100%;
    }
    
    .btn-secondary-custom:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #ffffff;
      text-decoration: none;
      transform: translateY(-1px);
    }
    
    .form-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .progress-bar-custom {
      display: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
      height: 8px;
    }
    
    .progress-fill {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .form-actions {
        grid-template-columns: 1fr;
      }
      
      .create-form-container {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar d-flex flex-column">
    <!-- Logo y Título -->
    <div class="navbar-brand d-flex align-items-center mb-4">
      <img src="/assets/logo_flowfit.png" alt="FlowFit" height="32" class="me-3 logo-entrenador" style="border-radius: 8px; filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));">
      <span class="brand-text fs-4 fw-bold text-white">FlowFit Coach</span>
    </div>

    <!-- Navegación Principal -->
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a th:href="@{/entrenador/dashboard}" class="nav-link entrenador-nav-link">
          <i class="bi bi-speedometer2 me-3"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/mis-usuarios}" class="nav-link entrenador-nav-link">
          <i class="bi bi-people me-3"></i>
          <span>Mis Usuarios</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/ejercicios}" class="nav-link entrenador-nav-link">
          <i class="bi bi-heart-pulse me-3"></i>
          <span>Mis Ejercicios</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/rutinas/crear}" class="nav-link entrenador-nav-link">
          <i class="bi bi-plus-circle me-3"></i>
          <span>Crear Rutinas</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/rutinas}" class="nav-link entrenador-nav-link">
          <i class="bi bi-list-check me-3"></i>
          <span>Ver Rutinas</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/asignar-rutinas}" class="nav-link entrenador-nav-link">
          <i class="bi bi-person-plus-fill me-3"></i>
          <span>Asignar Rutinas</span>
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/entrenador/progreso}" class="nav-link entrenador-nav-link">
          <i class="bi bi-graph-up me-3"></i>
          <span>Progreso de Usuarios</span>
        </a>
      </li>
      <li class="nav-item mt-4">
        <a th:href="@{/logout}" class="nav-link entrenador-nav-link logout-link">
          <i class="bi bi-box-arrow-right me-3"></i>
          <span>Cerrar Sesión</span>
        </a>
      </li>
    </ul>

    <!-- Perfil del Entrenador -->
    <div class="border-top pt-3 mt-auto">
      <div class="dropdown profile-dropdown-entrenador">
        <div class="profile-icon-entrenador d-flex align-items-center w-100" id="profileDropdownEntrenador" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="/assets/perfil_default.png" alt="Profile" class="profile-image-entrenador me-3" style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);">
          <div class="flex-grow-1">
            <div class="small fw-bold text-white" th:text="${entrenador != null ? #strings.substringBefore(entrenador.nombre, ' ') : 'Entrenador'}">Entrenador</div>
            <div class="small text-entrenador-muted">FlowFit Coach</div>
          </div>
          <i class="bi bi-chevron-down text-entrenador-accent"></i>
        </div>
        <ul class="dropdown-menu dropdown-menu-dark profile-dropdown-menu-entrenador">
          <li><a class="dropdown-item" th:href="@{/entrenador/perfil}"><i class="bi bi-person me-2"></i>Mi Perfil</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" th:href="@{/logout}"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Mobile menu button -->
  <button class="mobile-menu-btn d-lg-none" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Overlay para cerrar sidebar en mobile -->
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
      <div>
        <h1 class="mb-2">Crear Ejercicio Personalizado</h1>
        <p class="lead mb-0">Diseña un ejercicio único para tus rutinas</p>
      </div>
    </div>

    <!-- Mensajes de error -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span th:text="${errorMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Formulario -->
    <div class="create-form-container fade-in-up">
      <div class="form-header">
        <h2 class="form-title">
          <i class="bi bi-plus-circle me-2"></i>
          Nuevo Ejercicio
        </h2>
        <p class="form-subtitle">Completa la información para crear tu ejercicio personalizado</p>
      </div>

      <form th:action="@{/entrenador/ejercicios/crear}" method="post" enctype="multipart/form-data" id="createExerciseForm">
        
        <!-- Nombre del ejercicio -->
        <div class="form-group-custom">
          <label for="nombre" class="form-label-custom">
            <i class="bi bi-tag"></i>
            Nombre del Ejercicio
          </label>
          <input type="text" 
                 class="form-control form-control-custom" 
                 id="nombre" 
                 name="nombre" 
                 placeholder="Ej: Press de banca inclinado con mancuernas"
                 required 
                 maxlength="100">
          <div class="invalid-feedback">
            El nombre del ejercicio es requerido.
          </div>
        </div>

        <!-- Descripción -->
        <div class="form-group-custom">
          <label for="descripcion" class="form-label-custom">
            <i class="bi bi-text-paragraph"></i>
            Descripción e Instrucciones
          </label>
          <textarea class="form-control form-control-custom" 
                    id="descripcion" 
                    name="descripcion" 
                    rows="4"
                    placeholder="Describe cómo realizar el ejercicio, músculos trabajados, consejos de forma, etc..."
                    required 
                    maxlength="500"></textarea>
          <div class="invalid-feedback">
            La descripción es requerida.
          </div>
        </div>

        <!-- Upload de imagen -->
        <div class="form-group-custom">
          <label class="form-label-custom">
            <i class="bi bi-image"></i>
            Imagen del Ejercicio
          </label>
          
          <div class="file-upload-area" onclick="document.getElementById('imagen').click()" 
               ondrop="dropHandler(event)" 
               ondragover="dragOverHandler(event)"
               ondragleave="dragLeaveHandler(event)">
            
            <div class="file-upload-icon">
              <i class="bi bi-cloud-upload"></i>
            </div>
            
            <div class="file-upload-text">Subir imagen del ejercicio</div>
            <div class="file-upload-hint">Haz clic aquí o arrastra una imagen (JPG, PNG, máx. 5MB)</div>
            
            <input type="file" 
                   class="file-input-hidden" 
                   id="imagen" 
                   name="imagen" 
                   accept="image/*"
                   required
                   onchange="previewImage(event)">
          </div>
          
          <div class="image-preview-container" id="imagePreviewContainer">
            <img id="imagePreview" class="image-preview" alt="Vista previa">
          </div>
          
          <div class="progress-bar-custom" id="uploadProgress">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="form-actions">
          <a th:href="@{/entrenador/ejercicios}" class="btn-secondary-custom">
            <i class="bi bi-arrow-left me-2"></i>
            Cancelar
          </a>
          <button type="submit" class="btn-primary-custom" id="submitBtn">
            <i class="bi bi-plus-circle me-2"></i>
            Crear Ejercicio
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Variables globales
    let isSubmitting = false;

    // Funciones de drag and drop
    function dragOverHandler(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragover');
    }

    function dragLeaveHandler(event) {
      event.currentTarget.classList.remove('dragover');
    }

    function dropHandler(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('dragover');
      
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = document.getElementById('imagen');
        fileInput.files = files;
        previewImage({ target: fileInput });
      }
    }

    // Preview de imagen
    function previewImage(event) {
      const file = event.target.files[0];
      
      if (file) {
        // Validar tamaño de archivo (5MB máximo)
        const maxSize = 5 * 1024 * 1024; // 5MB en bytes
        if (file.size > maxSize) {
          alert('El archivo es demasiado grande. El tamaño máximo es 5MB.');
          event.target.value = '';
          return;
        }

        // Validar tipo de archivo
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
          alert('Tipo de archivo no válido. Solo se permiten imágenes JPG, PNG y GIF.');
          event.target.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('imagePreview');
          const container = document.getElementById('imagePreviewContainer');
          
          preview.src = e.target.result;
          container.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    // Validación del formulario
    function validateForm() {
      const form = document.getElementById('createExerciseForm');
      const nombre = document.getElementById('nombre').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();
      const imagen = document.getElementById('imagen').files[0];

      let isValid = true;

      // Validar nombre
      if (!nombre) {
        showFieldError('nombre', 'El nombre del ejercicio es requerido.');
        isValid = false;
      } else if (nombre.length < 3) {
        showFieldError('nombre', 'El nombre debe tener al menos 3 caracteres.');
        isValid = false;
      } else {
        clearFieldError('nombre');
      }

      // Validar descripción
      if (!descripcion) {
        showFieldError('descripcion', 'La descripción es requerida.');
        isValid = false;
      } else if (descripcion.length < 10) {
        showFieldError('descripcion', 'La descripción debe tener al menos 10 caracteres.');
        isValid = false;
      } else {
        clearFieldError('descripcion');
      }

      // Validar imagen
      if (!imagen) {
        alert('Por favor selecciona una imagen para el ejercicio.');
        isValid = false;
      }

      return isValid;
    }

    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      field.classList.add('is-invalid');
      
      let errorDiv = field.parentNode.querySelector('.invalid-feedback');
      if (errorDiv) {
        errorDiv.textContent = message;
      }
    }

    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      field.classList.remove('is-invalid');
    }

    // Manejar envío del formulario
    document.getElementById('createExerciseForm').addEventListener('submit', function(event) {
      if (isSubmitting) {
        event.preventDefault();
        return;
      }

      if (!validateForm()) {
        event.preventDefault();
        return;
      }

      // Mostrar estado de carga
      isSubmitting = true;
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Creando ejercicio...';
      submitBtn.disabled = true;

      // Simular progreso (opcional)
      const progressBar = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      
      progressBar.style.display = 'block';
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) {
          clearInterval(progressInterval);
        }
        progressFill.style.width = Math.min(progress, 90) + '%';
      }, 200);
    });

    // Funciones para sidebar móvil
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.add('active');
      document.querySelector('.sidebar-overlay').classList.add('active');
    }

    function closeSidebar() {
      document.querySelector('.sidebar').classList.remove('active');
      document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    // Limpiar errores al escribir
    document.getElementById('nombre').addEventListener('input', function() {
      if (this.value.trim().length >= 3) {
        clearFieldError('nombre');
      }
    });

    document.getElementById('descripcion').addEventListener('input', function() {
      if (this.value.trim().length >= 10) {
        clearFieldError('descripcion');
      }
    });
  </script>
</body>
</html>