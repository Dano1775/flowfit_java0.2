<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Rutinas - FlowFit Usuario</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link th:href="@{/css/usuario-dashboard.css}" rel="stylesheet">
  <link th:href="@{/css/rutinas-usuario.css}" rel="stylesheet">
</head>
<body class="dashboard-bg">

  <!-- Sidebar -->
  <nav class="sidebar d-flex flex-column">
    <div class="navbar-brand d-flex align-items-center mb-4">
      <img src="/assets/logo_flowfit_usuario.png" alt="FlowFit" height="32" class="me-3 logo-usuario" style="border-radius: 6px;">
      <span class="brand-text fs-4 fw-bold">FlowFit</span>
    </div>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item"><a th:href="@{/usuario/dashboard}" class="nav-link"><i class="bi bi-house me-2"></i> Mi Dashboard</a></li>
      <li><a th:href="@{/usuario/rutinas}" class="nav-link active"><i class="bi bi-calendar-check me-2"></i> Mis Rutinas</a></li>
      <li><a th:href="@{/usuario/ejercicios}" class="nav-link"><i class="bi bi-activity me-2"></i> Ejercicios</a></li>
      <li><a th:href="@{/usuario/progreso}" class="nav-link"><i class="bi bi-graph-up me-2"></i> Mi Progreso</a></li>
      <li><a th:href="@{/usuario/perfil}" class="nav-link"><i class="bi bi-person me-2"></i> Mi Perfil</a></li>
    </ul>
    <div class="border-top pt-3 mt-auto text-white">
      <!-- Profile Section with Image -->
      <div class="dropdown profile-dropdown">
        <div class="profile-icon d-flex align-items-center w-100" id="profileDropdownUsuario" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="/assets/perfil_default.png" alt="Profile" class="profile-image me-2" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          <div class="flex-grow-1">
            <div class="small fw-bold" th:text="${usuario.nombre}">Usuario</div>
            <div class="small text-muted">Mi Panel</div>
          </div>
          <i class="bi bi-chevron-down"></i>
        </div>
        <ul class="dropdown-menu profile-menu" aria-labelledby="profileDropdownUsuario">
          <li><a class="dropdown-item" th:href="@{/usuario/perfil}"><i class="bi bi-person-gear me-2"></i>Mi Perfil</a></li>
          <li><a class="dropdown-item" href="/configuracion"><i class="bi bi-gear me-2"></i>Configuración</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" th:href="@{/logout}"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="content">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-start mb-4">
      <div>
        <h1>Mis Rutinas de Entrenamiento</h1>
        <p class="lead mb-1">Explora y sigue tus rutinas personalizadas</p>
        <small class="text-muted">
          <i class="bi bi-calendar3 me-1"></i>
          <span th:text="${#dates.format(#dates.createNow(), 'EEEE, dd MMMM yyyy')}">Fecha actual</span>
        </small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-usuario-primary" data-bs-toggle="modal" data-bs-target="#filtrosModal">
          <i class="bi bi-funnel me-2"></i>Filtrar
        </button>
        <a th:href="@{/usuario/progreso}" class="btn btn-outline-usuario">
          <i class="bi bi-graph-up me-2"></i>Ver Progreso
        </a>
      </div>
    </div>

    <!-- Alert Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle me-2"></i>
      <span th:text="${successMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-circle me-2"></i>
      <span th:text="${errorMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="glass-card stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1" th:text="${rutinasActivasCount}">0</h4>
              <p class="text-muted mb-0">Rutinas Activas</p>
            </div>
            <div class="stats-icon">
              <i class="bi bi-activity fs-2"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="glass-card stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1" th:text="${rutinasCompletadasCount}">0</h4>
              <p class="text-muted mb-0">Completadas</p>
            </div>
            <div class="stats-icon">
              <i class="bi bi-check-circle fs-2"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="glass-card stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1" th:text="${totalRutinas}">0</h4>
              <p class="text-muted mb-0">Total Asignadas</p>
            </div>
            <div class="stats-icon">
              <i class="bi bi-lightning fs-2"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="glass-card stats-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1" th:text="${progresoGeneral != null ? progresoGeneral + '%' : '0%'}">0%</h4>
              <p class="text-muted mb-0">Progreso General</p>
            </div>
            <div class="stats-icon">
              <i class="bi bi-trophy fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rutinas Activas -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="glass-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="bi bi-play-circle me-2"></i>Rutinas Activas</h4>
            <span class="badge bg-success" th:text="${rutinasActivasCount + ' activas'}">0 activas</span>
          </div>
          
          <!-- Mensaje si no hay rutinas activas -->
          <div th:if="${rutinasActivas == null or #lists.isEmpty(rutinasActivas)}" class="text-center py-4">
            <i class="bi bi-calendar-x fs-1 text-muted mb-3 d-block"></i>
            <h5 class="text-muted">No tienes rutinas activas</h5>
            <p class="text-muted mb-3">¡Comienza tu journey fitness agregando rutinas recomendadas!</p>
            <a href="#rutinas-recomendadas" class="btn btn-usuario-primary">
              <i class="bi bi-plus me-2"></i>Explorar Rutinas
            </a>
          </div>

          <!-- Lista de rutinas activas -->
          <div th:if="${rutinasActivas != null and not #lists.isEmpty(rutinasActivas)}" class="row">
            <div th:each="rutinaAsignada : ${rutinasActivas}" class="col-lg-4 col-md-6 mb-3">
              <div class="rutina-card">
                <div class="rutina-header">
                  <h5 th:text="${rutinaAsignada.rutina.nombre}">Nombre de la Rutina</h5>
                  <span class="badge bg-primary" th:text="${rutinaAsignada.rutina.categoria}">Tipo</span>
                </div>
                <div class="rutina-info">
                  <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-clock me-1"></i><span th:text="${rutinaAsignada.rutina.duracionMinutos}">30</span> min</span>
                    <span><i class="bi bi-fire me-1"></i><span th:text="${rutinaAsignada.rutina.caloriasEstimadas}">200</span> kcal</span>
                  </div>
                  <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar bg-success" th:style="'width: ' + ${rutinaAsignada.progreso} + '%'"></div>
                  </div>
                  <small class="text-muted">Progreso: <span th:text="${rutinaAsignada.progreso}">0</span>%</small>
                </div>
                <div class="rutina-actions mt-3">
                  <form th:action="@{/usuario/rutinas/completar}" method="post" class="d-inline">
                    <input type="hidden" name="rutinaAsignadaId" th:value="${rutinaAsignada.id}">
                    <button type="submit" class="btn btn-success btn-sm me-2">
                      <i class="bi bi-check me-1"></i>Completar
                    </button>
                  </form>
                  <button class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-eye me-1"></i>Ver Detalles
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rutinas Recomendadas -->
    <div class="row" id="rutinas-recomendadas">
      <div class="col-12">
        <div class="glass-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="bi bi-star me-2"></i>Rutinas Recomendadas</h4>
            <span class="badge bg-info" th:text="${rutinasDisponibles != null ? rutinasDisponibles.size() + ' disponibles' : '0 disponibles'}">0 disponibles</span>
          </div>
          
          <!-- Mensaje si no hay rutinas disponibles -->
          <div th:if="${rutinasDisponibles == null or #lists.isEmpty(rutinasDisponibles)}" class="text-center py-4">
            <i class="bi bi-star fs-1 text-muted mb-3 d-block"></i>
            <h5 class="text-muted">No hay rutinas disponibles</h5>
            <p class="text-muted">Pronto tendremos más rutinas para ti.</p>
          </div>

          <!-- Lista de rutinas disponibles -->
          <div th:if="${rutinasDisponibles != null and not #lists.isEmpty(rutinasDisponibles)}" class="row">
            <div th:each="rutina : ${rutinasDisponibles}" class="col-lg-4 col-md-6 mb-3">
              <div class="rutina-card rutina-recommended">
                <div class="rutina-header">
                  <h5 th:text="${rutina.nombre}">Nombre de la Rutina</h5>
                  <span class="badge bg-success" th:text="${rutina.dificultad}">Nivel</span>
                </div>
                <div class="rutina-info">
                  <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-clock me-1"></i><span th:text="${rutina.duracionMinutos}">30</span> min</span>
                    <span><i class="bi bi-fire me-1"></i><span th:text="${rutina.caloriasEstimadas}">200</span> kcal</span>
                  </div>
                  <p class="small text-muted" th:text="${rutina.descripcion}">Descripción de la rutina.</p>
                  <div class="d-flex justify-content-between small">
                    <span><i class="bi bi-person me-1"></i><span th:text="${rutina.tipoRutina}">Tipo</span></span>
                    <span th:if="${rutina.entrenadorId != null}"><i class="bi bi-award me-1"></i>Con Entrenador</span>
                    <span th:if="${rutina.entrenadorId == null}"><i class="bi bi-globe me-1"></i>Global</span>
                  </div>
                </div>
                <div class="rutina-actions mt-3">
                  <form th:action="@{/usuario/rutinas/asignar}" method="post" class="d-inline">
                    <input type="hidden" name="rutinaId" th:value="${rutina.id}">
                    <button type="submit" class="btn btn-usuario-primary btn-sm w-100">
                      <i class="bi bi-plus me-1"></i>Agregar a Mis Rutinas
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rutinas Populares -->
    <div class="row mt-4" th:if="${rutinasPopulares != null and not #lists.isEmpty(rutinasPopulares)}">
      <div class="col-12">
        <div class="glass-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="bi bi-fire me-2"></i>Rutinas Populares</h4>
            <span class="badge bg-warning text-dark">Más Elegidas</span>
          </div>
          
          <div class="row">
            <div th:each="rutina : ${rutinasPopulares}" class="col-lg-4 col-md-6 mb-3">
              <div class="rutina-card rutina-popular">
                <div class="rutina-header">
                  <h5 th:text="${rutina.nombre}">Rutina Popular</h5>
                  <span class="badge bg-warning text-dark">Popular</span>
                </div>
                <div class="rutina-info">
                  <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-clock me-1"></i><span th:text="${rutina.duracionEstimadaMinutos}">30</span> min</span>
                    <span><i class="bi bi-fire me-1"></i><span th:text="${rutina.caloriasEstimadas}">200</span> kcal</span>
                  </div>
                  <p class="small text-muted" th:text="${rutina.descripcion}">Descripción de la rutina.</p>
                </div>
                <div class="rutina-actions mt-3">
                  <form th:action="@{/usuario/rutinas/asignar}" method="post" class="d-inline">
                    <input type="hidden" name="rutinaId" th:value="${rutina.id}">
                    <button type="submit" class="btn btn-warning btn-sm w-100 text-dark">
                      <i class="bi bi-star me-1"></i>Probar Rutina Popular
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JavaScript -->
  <script>
    // Auto-hide alerts after 5 seconds
    setTimeout(function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(alert => {
        if (alert.classList.contains('show')) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }
      });
    }, 5000);

    // Smooth scroll to recommended routines
    document.addEventListener('DOMContentLoaded', function() {
      const exploreBtn = document.querySelector('a[href="#rutinas-recomendadas"]');
      if (exploreBtn) {
        exploreBtn.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('rutinas-recomendadas').scrollIntoView({
            behavior: 'smooth'
          });
        });
      }
    });

    // Confirm completion of routine
    document.querySelectorAll('form[action*="completar"] button').forEach(button => {
      button.addEventListener('click', function(e) {
        if (!confirm('¿Estás seguro de que has completado esta rutina?')) {
          e.preventDefault();
        }
      });
    });
  </script>

</body>
</html>