<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Progreso - FlowFit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/usuario-dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/progreso-usuario.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-body">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img th:src="@{/images/logo_flowfit_usuario.png}" alt="FlowFit" class="sidebar-logo">
      <h5 class="text-white mb-0">FlowFit</h5>
    </div>
    <ul class="nav flex-column sidebar-nav">
      <li><a th:href="@{/usuario/dashboard}" class="nav-link"><i class="bi bi-house me-2"></i> Inicio</a></li>
      <li><a th:href="@{/usuario/rutinas}" class="nav-link"><i class="bi bi-calendar-check me-2"></i> Mis Rutinas</a></li>
      <li><a th:href="@{/usuario/ejercicios}" class="nav-link"><i class="bi bi-lightning me-2"></i> Ejercicios</a></li>
      <li><a th:href="@{/usuario/progreso}" class="nav-link active"><i class="bi bi-graph-up me-2"></i> Mi Progreso</a></li>
      <li><a th:href="@{/usuario/perfil}" class="nav-link"><i class="bi bi-person me-2"></i> Mi Perfil</a></li>
    </ul>
    <div class="sidebar-footer">
      <a th:href="@{/logout}" class="nav-link text-danger">
        <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <!-- Header -->
    <header class="main-header">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light me-3 sidebar-toggle" id="sidebarToggle">
          <i class="bi bi-list"></i>
        </button>
        <div>
          <h1 class="h3 mb-0 fw-bold text-white">Mi Progreso</h1>
          <p class="mb-0 text-light opacity-75">Visualiza tu evolución y logros</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="user-info me-3 text-end">
          <span class="fw-medium text-white" th:text="${usuario.nombre}">Usuario</span>
          <small class="d-block text-light opacity-75" th:text="${usuario.correo}">email</small>
        </div>
        <div class="user-avatar">
          <i class="bi bi-person-circle text-white"></i>
        </div>
      </div>
    </header>

    <!-- Contenido Principal -->
    <div class="content-wrapper">
      
      <!-- Estadísticas Generales -->
      <div class="row mb-4">
        <!-- Progreso General -->
        <div class="col-lg-3 col-md-6 mb-4">
          <div class="glass-card stat-card">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-success">
                <i class="bi bi-trophy-fill text-white"></i>
              </div>
              <div class="ms-3 flex-grow-1">
                <h3 class="stat-number mb-1" th:text="${progresoGeneral != null ? progresoGeneral + '%' : '0%'}">85%</h3>
                <p class="stat-label mb-0">Progreso General</p>
                <div class="progress mt-2" style="height: 6px;">
                  <div class="progress-bar bg-success" th:style="'width: ' + ${progresoGeneral != null ? progresoGeneral : 0} + '%'"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Rutinas Completadas -->
        <div class="col-lg-3 col-md-6 mb-4">
          <div class="glass-card stat-card">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-primary">
                <i class="bi bi-check-circle-fill text-white"></i>
              </div>
              <div class="ms-3">
                <h3 class="stat-number mb-1" th:text="${rutinasCompletadas}">12</h3>
                <p class="stat-label mb-0">Rutinas Completadas</p>
                <small class="text-muted">de <span th:text="${rutinasTotal}">15</span> asignadas</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Días Activos -->
        <div class="col-lg-3 col-md-6 mb-4">
          <div class="glass-card stat-card">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-warning">
                <i class="bi bi-calendar-week text-white"></i>
              </div>
              <div class="ms-3">
                <h3 class="stat-number mb-1" th:text="${diasActivosEsteMes}">18</h3>
                <p class="stat-label mb-0">Días Activos</p>
                <small class="text-muted">este mes</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Racha Actual -->
        <div class="col-lg-3 col-md-6 mb-4">
          <div class="glass-card stat-card">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-danger">
                <i class="bi bi-fire text-white"></i>
              </div>
              <div class="ms-3">
                <h3 class="stat-number mb-1" th:text="${rachaActual}">7</h3>
                <p class="stat-label mb-0">Racha Actual</p>
                <small class="text-muted">días consecutivos</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráficos de Progreso -->
      <div class="row mb-4">
        <!-- Progreso Semanal -->
        <div class="col-lg-8 mb-4">
          <div class="glass-card chart-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1 fw-bold text-white">
                  <i class="bi bi-graph-up me-2 text-success"></i>Progreso Semanal
                </h5>
                <p class="text-muted mb-0 small">Tu evolución en los últimos 7 días</p>
              </div>
              <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="cambiarPeriodoGrafico('7')">Últimos 7 días</a></li>
                  <li><a class="dropdown-item" href="#" onclick="cambiarPeriodoGrafico('30')">Último mes</a></li>
                  <li><a class="dropdown-item" href="#" onclick="cambiarPeriodoGrafico('90')">Últimos 3 meses</a></li>
                </ul>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="progresoChart" height="300"></canvas>
            </div>
          </div>
        </div>

        <!-- Distribución de Rutinas -->
        <div class="col-lg-4 mb-4">
          <div class="glass-card chart-card">
            <div class="card-header">
              <h5 class="mb-1 fw-bold text-white">
                <i class="bi bi-pie-chart me-2 text-info"></i>Estado de Rutinas
              </h5>
              <p class="text-muted mb-0 small">Distribución actual</p>
            </div>
            <div class="chart-container">
              <canvas id="distribucionChart" height="250"></canvas>
            </div>
            <div class="chart-legend mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                  <div class="legend-dot bg-success me-2"></div>
                  <span class="small text-muted">Completadas</span>
                </div>
                <span class="small fw-medium text-white" th:text="${rutinasCompletadas}">12</span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                  <div class="legend-dot bg-primary me-2"></div>
                  <span class="small text-muted">En Progreso</span>
                </div>
                <span class="small fw-medium text-white" th:text="${rutinasEnProgreso}">3</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="legend-dot bg-secondary me-2"></div>
                  <span class="small text-muted">Pausadas</span>
                </div>
                <span class="small fw-medium text-white">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rutinas Recientes y Motivación -->
      <div class="row mb-4">
        <!-- Rutinas Recientes -->
        <div class="col-lg-8 mb-4">
          <div class="glass-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1 fw-bold text-white">
                  <i class="bi bi-clock-history me-2 text-warning"></i>Actividad Reciente
                </h5>
                <p class="text-muted mb-0 small">Tus últimas rutinas trabajadas</p>
              </div>
              <a th:href="@{/usuario/rutinas}" class="btn btn-outline-success btn-sm">
                <i class="bi bi-eye me-1"></i>Ver Todas
              </a>
            </div>
            <div class="rutinas-recientes">
              <div th:each="rutina : ${rutinasAsignadas}" th:if="${rutinaStat.index < 5}" 
                   class="rutina-reciente-item">
                <div class="d-flex align-items-center">
                  <div class="rutina-status" th:classappend="${rutina.estado.toString() == 'COMPLETADA'} ? 'completed' : 'active'">
                    <i th:class="${rutina.estado.toString() == 'COMPLETADA'} ? 'bi bi-check-circle-fill' : 'bi bi-play-circle-fill'"></i>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1 text-white" th:text="'Rutina ID: ' + ${rutina.rutinaId}">Rutina de Fuerza</h6>
                    <div class="d-flex align-items-center">
                      <small class="text-muted me-3" th:text="'Asignada: ' + ${#temporals.format(rutina.fechaAsignacion, 'dd/MM/yyyy')}">Asignada: 15/03/2024</small>
                      <div class="progress flex-grow-1 me-3" style="height: 6px;">
                        <div class="progress-bar bg-success" th:style="'width: ' + ${rutina.progreso} + '%'"></div>
                      </div>
                      <small class="text-muted" th:text="${rutina.progreso} + '%'">85%</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel de Motivación -->
        <div class="col-lg-4 mb-4">
          <div class="glass-card motivation-card">
            <div class="text-center">
              <div class="motivation-icon">
                <i class="bi bi-award-fill text-warning"></i>
              </div>
              <h5 class="text-white fw-bold mb-2">¡Excelente Progreso!</h5>
              <p class="text-muted mb-3">Has completado <span class="text-success fw-bold" th:text="${rutinasCompletadas}">12</span> rutinas este mes.</p>
              
              <!-- Próximos Objetivos -->
              <div class="objetivos-section">
                <h6 class="text-white mb-3">
                  <i class="bi bi-target me-2"></i>Próximos Objetivos
                </h6>
                <div class="objetivo-item mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">Completar 15 rutinas</span>
                    <span class="badge bg-primary" th:text="${rutinasCompletadas} + '/15'">12/15</span>
                  </div>
                  <div class="progress mt-1" style="height: 4px;">
                    <div class="progress-bar bg-primary" th:style="'width: ' + ${(rutinasCompletadas * 100) / 15} + '%'"></div>
                  </div>
                </div>
                <div class="objetivo-item mb-2">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">Racha de 10 días</span>
                    <span class="badge bg-warning" th:text="${rachaActual} + '/10'">7/10</span>
                  </div>
                  <div class="progress mt-1" style="height: 4px;">
                    <div class="progress-bar bg-warning" th:style="'width: ' + ${(rachaActual * 100) / 10} + '%'"></div>
                  </div>
                </div>
                <div class="objetivo-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">20 días activos</span>
                    <span class="badge bg-success" th:text="${diasActivosEsteMes} + '/20'">18/20</span>
                  </div>
                  <div class="progress mt-1" style="height: 4px;">
                    <div class="progress-bar bg-success" th:style="'width: ' + ${(diasActivosEsteMes * 100) / 20} + '%'"></div>
                  </div>
                </div>
              </div>

              <!-- Mensaje Motivacional -->
              <div class="motivation-message mt-4 p-3 rounded-3" style="background: rgba(255, 255, 255, 0.1);">
                <i class="bi bi-emoji-smile text-success mb-2 fs-4"></i>
                <p class="small text-white mb-0">
                  <span th:if="${progresoGeneral >= 80}">¡Estás en una racha increíble! Sigue así y alcanzarás tus metas.</span>
                  <span th:if="${progresoGeneral >= 60 && progresoGeneral < 80}">¡Muy buen trabajo! Estás por encima del promedio.</span>
                  <span th:if="${progresoGeneral >= 40 && progresoGeneral < 60}">Buen progreso. Mantén la consistencia para mejores resultados.</span>
                  <span th:if="${progresoGeneral < 40}">¡Cada paso cuenta! Mantén el ritmo y verás mejoras pronto.</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Sidebar Toggle
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('sidebar').classList.toggle('collapsed');
      document.getElementById('main-content').classList.toggle('expanded');
    });

    // Datos reales desde Thymeleaf
    const progresoGeneralData = /*[[${progresoGeneral}]]*/ 0;
    const rutinasCompletadasData = /*[[${rutinasCompletadas}]]*/ 0;
    const rutinasEnProgresoData = /*[[${rutinasEnProgreso}]]*/ 0;
    const diasActivosData = /*[[${diasActivosEsteMes}]]*/ 0;
    const rachaActualData = /*[[${rachaActual}]]*/ 0;

    // Gráfico de Progreso Semanal
    const ctx = document.getElementById('progresoChart').getContext('2d');
    
    // Generar datos de progreso simulados basados en el progreso real del usuario
    const generateWeeklyData = () => {
      const baseProgress = progresoGeneralData;
      const variation = 10; // Variación máxima
      return Array.from({length: 7}, (_, i) => {
        const randomVariation = (Math.random() - 0.5) * variation;
        return Math.max(0, Math.min(100, baseProgress + randomVariation));
      });
    };

    const progresoChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
        datasets: [{
          label: 'Progreso %',
          data: generateWeeklyData(),
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#28a745',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        elements: {
          point: {
            hoverRadius: 8
          }
        }
      }
    });

    // Gráfico de Distribución
    const ctx2 = document.getElementById('distribucionChart').getContext('2d');
    const distribucionChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Completadas', 'En Progreso', 'Pausadas'],
        datasets: [{
          data: [/*[[${rutinasCompletadas}]]*/ 12, /*[[${rutinasEnProgreso}]]*/ 3, 0],
          backgroundColor: ['#28a745', '#007bff', '#6c757d'],
          borderWidth: 0,
          cutout: '70%'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });

    // Función para cambiar período del gráfico
    function cambiarPeriodoGrafico(dias) {
      // Aquí se puede implementar lógica para cambiar los datos del gráfico
      console.log('Cambiando a período de ' + dias + ' días');
      // Por ahora solo mostramos un mensaje
      const toast = new bootstrap.Toast(document.createElement('div'));
      // Implementar cambio de datos si es necesario
    }

    // Animaciones de entrada
    window.addEventListener('load', function() {
      // Animar las tarjetas de estadísticas
      const statCards = document.querySelectorAll('.stat-card');
      statCards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'all 0.5s ease';
          
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 100);
        }, index * 100);
      });

      // Animar números con efecto contador
      const statNumbers = document.querySelectorAll('.stat-number');
      statNumbers.forEach(number => {
        const finalValue = parseInt(number.textContent.replace(/[^\d]/g, ''));
        if (!isNaN(finalValue)) {
          animateNumber(number, 0, finalValue, 1500);
        }
      });
    });

    // Función para animar números
    function animateNumber(element, start, end, duration) {
      let startTime = null;
      const originalText = element.textContent;
      const suffix = originalText.replace(/[\d]/g, '');
      
      function animate(currentTime) {
        if (startTime === null) startTime = currentTime;
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const current = Math.round(progress * (end - start) + start);
        element.textContent = current + suffix;
        
        if (progress < 1) {
          requestAnimationFrame(animate);
        }
      }
      
      requestAnimationFrame(animate);
    }
  </script>
</body>
</html>