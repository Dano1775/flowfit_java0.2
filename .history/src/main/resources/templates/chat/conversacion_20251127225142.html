<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - FlowFit</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- FlowFit CSS System -->
  <link th:href="@{/css/flowfit-base.css}" rel="stylesheet">
  <link th:href="@{/css/flowfit-usuario.css}" rel="stylesheet" th:if="${esUsuario}">
  <link th:href="@{/css/flowfit-entrenador.css}" rel="stylesheet" th:unless="${esUsuario}">
  
  <style>
    .chat-container {
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }
    
    /* Mensajes Container con glassmorphism */
    .mensajes-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.1);
      border-radius: 16px;
      margin-bottom: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .mensajes-container::-webkit-scrollbar {
      width: 8px;
    }
    .mensajes-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }
    .mensajes-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }
    
    /* Mensajes con animaci칩n mejorada */
    .mensaje-item {
      display: flex;
      margin-bottom: 1.2rem;
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95);
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
    }
    
    .mensaje-item.enviado {
      justify-content: flex-end;
    }
    
    /* Burbujas de mensaje mejoradas */
    .mensaje-bubble {
      max-width: 70%;
      padding: 0.9rem 1.2rem;
      border-radius: 18px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .mensaje-bubble:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    
    .mensaje-item.recibido .mensaje-bubble {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(102, 126, 234, 0.15) 100%);
      border: 1px solid rgba(102, 126, 234, 0.4);
      border-top-left-radius: 4px;
    }
    
    .mensaje-item.enviado .mensaje-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-top-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .mensaje-sistema {
      text-align: center;
      margin: 2rem 0;
    }
    .mensaje-sistema .badge {
      padding: 0.6rem 1.2rem;
      font-weight: 500;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    /* Propuesta Card mejorada */
    .propuesta-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 2px solid rgba(102, 126, 234, 0.4);
      border-radius: 20px;
      padding: 1.8rem;
      margin: 1.5rem 0;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .propuesta-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
    }
    
    .propuesta-card.enviada {
      margin-left: auto;
      border-color: rgba(118, 75, 162, 0.6);
    }
    
    .propuesta-precio {
      font-size: 2.2rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0.5rem 0;
    }
    
    /* Barra de entrada mejorada */
    .chat-input-area {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .chat-actions-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .action-btn {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid rgba(102, 126, 234, 0.3);
      background: rgba(102, 126, 234, 0.1);
      color: #fff;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }
    
    .action-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .action-btn i {
      font-size: 1.1rem;
    }
    
    #mensajeInput {
      background: rgba(0, 0, 0, 0.3) !important;
      border: 1px solid rgba(102, 126, 234, 0.3) !important;
      color: #fff !important;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      transition: all 0.3s ease;
    }
    
    #mensajeInput:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3) !important;
      border-color: #667eea !important;
      background: rgba(0, 0, 0, 0.4) !important;
    }
    
    .btn-send {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      padding: 0.8rem 1.5rem;
      transition: all 0.3s ease;
    }
    
    .btn-send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
    }
    
    /* Escrow Badge mejorado */
    .escrow-badge {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      padding: 1.2rem 1.8rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .escrow-badge.retenido {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .escrow-badge.esperando {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .escrow-badge.liberado {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    /* Header del chat mejorado */
    .chat-header {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 1.2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* Archivo/Imagen inputs ocultos */
    .file-input {
      display: none;
    }
    
    /* Animaci칩n de spinner */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spin {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    
    @media (max-width: 768px) {
      .mensaje-bubble {
        max-width: 85%;
      }
      .propuesta-card {
        max-width: 90%;
      }
      .escrow-badge {
        position: static;
        margin-bottom: 1rem;
      }
      .action-btn span {
        display: none;
      }
      .action-btn {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Desktop Toggle (for collapse) -->
  <button class="sidebar-collapse-btn d-none d-md-flex" id="sidebarCollapseBtn" title="Contraer/Expandir Sidebar">
    <i class="bi bi-chevron-left"></i>
  </button>

  <!-- Mobile Toggle -->
  <button class="sidebar-toggle-base d-md-none" id="sidebarToggle" 
          th:classappend="${esUsuario} ? 'sidebar-toggle-usuario' : 'sidebar-toggle-entrenador'">
    <i class="bi bi-list fs-4"></i>
  </button>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay-base" id="sidebarOverlay"></div>

  <!-- FlowFit Sidebar -->
  <div th:replace="~{${esUsuario ? 'fragments/sidebar-usuario' : 'fragments/sidebar-entrenador'} :: sidebar}"></div>

  <!-- Main Content -->
  <main class="main-content-base fade-in-up">
    <div class="container-fluid p-4">
      
      <!-- Escrow Status Badge (si hay contrataci칩n activa) -->
      <div th:if="${contratacion != null && contratacion.pago != null}" 
           class="escrow-badge"
           th:classappend="${contratacion.pago.estadoEscrow.name() == 'RETENIDO' ? 'retenido' : 
                           (contratacion.pago.estadoEscrow.name() == 'LIBERADO' ? 'liberado' : 'esperando')}">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-shield-check fs-4"></i>
          <div>
            <div class="fw-bold">Estado del Pago</div>
            <small th:text="${contratacion.pago.estadoEscrow.name()}">RETENIDO</small>
          </div>
        </div>
      </div>
      
      <!-- Header del Chat -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="chat-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <a th:href="@{/chat}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i>
              </a>
              <img src="/assets/perfil_default.png" class="rounded-circle me-3" width="50" height="50" alt="Avatar">
              <div>
                <h4 class="text-white mb-0 fw-bold">
                  <span th:if="${esUsuario}" th:text="${conversacion.entrenador.nombre}">Entrenador</span>
                  <span th:unless="${esUsuario}" th:text="${conversacion.usuario.nombre}">Usuario</span>
                </h4>
                <small class="text-muted-flowfit">
                  <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i>
                  En l칤nea
                </small>
              </div>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline-secondary" data-bs-toggle="dropdown">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li th:if="${!esUsuario}">
                  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalEnviarPropuesta">
                    <i class="bi bi-send me-2"></i>Enviar Propuesta
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="archivarConversacion()">
                  <i class="bi bi-archive me-2"></i>Archivar
                </a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Chat Container -->
      <div class="chat-container">
        
        <!-- Mensajes -->
        <div class="mensajes-container" id="mensajesContainer">
          
          <div th:each="mensaje : ${mensajes}">
            
            <!-- Mensaje de Sistema -->
            <div th:if="${mensaje.tipoMensaje.name() == 'SISTEMA'}" class="mensaje-sistema">
              <span class="badge bg-secondary">
                <i class="bi bi-info-circle me-1"></i>
                <span th:text="${mensaje.contenido}">Mensaje del sistema</span>
              </span>
            </div>
            
            <!-- Mensaje de Propuesta -->
            <div th:if="${mensaje.tipoMensaje.name() == 'PROPUESTA_PLAN'}" 
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviada' : ''}">
              <div class="propuesta-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h5 class="text-white mb-0">
                    <i class="bi bi-file-text me-2"></i>
                    Propuesta de Plan
                  </h5>
                  <span class="badge bg-warning text-dark" th:if="${mensaje.metadata != null}">
                    <span th:text="'Versi칩n ' + ${mensaje.metadata.get('version')}">v1</span>
                  </span>
                </div>
                
                <div class="mb-3">
                  <h6 class="text-muted-flowfit mb-1">Plan:</h6>
                  <p class="text-white mb-0" th:text="${mensaje.metadata != null ? mensaje.metadata.get('nombrePlan') : 'Plan personalizado'}">
                    Plan Premium
                  </p>
                </div>
                
                <div class="mb-3">
                  <h6 class="text-muted-flowfit mb-1">Precio:</h6>
                  <div class="propuesta-precio">
                    $<span th:text="${mensaje.metadata != null ? #numbers.formatDecimal(mensaje.metadata.get('precioFinal'), 0, 'COMMA', 0, 'POINT') : '0'}">
                      50.000
                    </span>
                    <small class="fs-6 text-muted-flowfit">COP/mes</small>
                  </div>
                </div>
                
                <div class="mb-3" th:if="${mensaje.metadata != null && mensaje.metadata.get('duracionDias') != null}">
                  <h6 class="text-muted-flowfit mb-1">Duraci칩n:</h6>
                  <p class="text-white mb-0">
                    <i class="bi bi-calendar me-1"></i>
                    <span th:text="${mensaje.metadata.get('duracionDias')} + ' d칤as'">30 d칤as</span>
                  </p>
                </div>
                
                <div class="mb-3" th:if="${mensaje.contenido != null && !mensaje.contenido.isEmpty()}">
                  <h6 class="text-muted-flowfit mb-1">Comentarios:</h6>
                  <p class="text-white small mb-0" th:text="${mensaje.contenido}">
                    Comentarios adicionales...
                  </p>
                </div>
                
                <!-- Botones de Acci칩n -->
                <div class="d-flex gap-2 mt-3" 
                     th:if="${mensaje.remitenteId != usuario.id}">
                  <button class="btn btn-success flex-fill" 
                          th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                          onclick="aceptarPropuesta(this)">
                    <i class="bi bi-check-circle me-1"></i>Aceptar
                  </button>
                  <button class="btn btn-danger flex-fill"
                          th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                          onclick="rechazarPropuesta(this)">
                    <i class="bi bi-x-circle me-1"></i>Rechazar
                  </button>
                  <button class="btn btn-warning flex-fill"
                          th:attr="data-contratacion-id=${mensaje.metadata != null ? mensaje.metadata.get('contratacionId') : ''}"
                          data-bs-toggle="modal" 
                          data-bs-target="#modalContraoferta">
                    <i class="bi bi-arrow-repeat me-1"></i>Contraoferta
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Mensaje Normal de Texto -->
            <div th:if="${mensaje.tipoMensaje.name() == 'TEXTO'}" 
                 class="mensaje-item"
                 th:classappend="${mensaje.remitenteId == usuario.id ? 'enviado' : 'recibido'}">
              <div class="mensaje-bubble">
                <p class="mb-1 text-white" th:text="${mensaje.contenido}">Contenido del mensaje</p>
                <small class="text-muted-flowfit" style="font-size: 0.75rem;">
                  <span th:text="${#temporals.format(mensaje.fechaEnvio, 'HH:mm')}">12:34</span>
                </small>
              </div>
            </div>
            
            <!-- Confirmaci칩n de Servicio -->
            <div th:if="${mensaje.tipoMensaje.name() == 'CONFIRMACION_SERVICIO'}" class="mensaje-sistema">
              <span class="badge bg-success">
                <i class="bi bi-check-circle-fill me-1"></i>
                <span th:text="${mensaje.contenido}">Servicio confirmado</span>
              </span>
            </div>
            
            <!-- Disputa Iniciada -->
            <div th:if="${mensaje.tipoMensaje.name() == 'DISPUTA_INICIADA'}" class="mensaje-sistema">
              <span class="badge bg-danger">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                <span th:text="${mensaje.contenido}">Disputa iniciada</span>
              </span>
            </div>
            
          </div>
          
          <!-- Empty State -->
          <div th:if="${mensajes == null || #lists.isEmpty(mensajes)}" class="text-center py-5">
            <i class="bi bi-chat-dots text-muted-flowfit" style="font-size: 4rem; opacity: 0.3;"></i>
            <p class="text-muted-flowfit mt-3">No hay mensajes a칰n. 춰Inicia la conversaci칩n!</p>
          </div>
          
        </div>
        
        <!-- Botones de Confirmaci칩n de Escrow (si aplica) -->
        <div th:if="${contratacion != null && contratacion.pago != null && contratacion.pago.estadoEscrow.name() == 'RETENIDO'}"
             class="mb-3">
          <div class="alert alert-info d-flex align-items-center justify-content-between">
            <div>
              <i class="bi bi-shield-lock me-2"></i>
              <strong>Pago Protegido:</strong> El dinero est치 retenido de forma segura.
            </div>
            <button class="btn btn-sm btn-success" 
                    th:attr="data-pago-id=${contratacion.pago.id}"
                    onclick="confirmarServicio(this)">
              <i class="bi bi-check-circle me-1"></i>
              Confirmar Servicio Recibido
            </button>
          </div>
        </div>
        
        <!-- Input de Mensaje con Acciones R치pidas -->
        <div class="chat-input-area">
          <!-- Barra de Acciones R치pidas -->
          <div class="chat-actions-bar">
            <button type="button" class="action-btn" onclick="document.getElementById('imagenInput').click()" title="Enviar imagen">
              <i class="bi bi-image"></i>
              <span>Imagen</span>
            </button>
            <button type="button" class="action-btn" onclick="document.getElementById('videoInput').click()" title="Enviar video">
              <i class="bi bi-camera-video"></i>
              <span>Video</span>
            </button>
            <button type="button" class="action-btn" onclick="document.getElementById('archivoInput').click()" title="Enviar archivo">
              <i class="bi bi-paperclip"></i>
              <span>Archivo</span>
            </button>
            <button type="button" class="action-btn" th:unless="${esUsuario}" data-bs-toggle="modal" data-bs-target="#modalEnviarPropuesta" title="Enviar propuesta de plan">
              <i class="bi bi-clipboard-check"></i>
              <span>Propuesta</span>
            </button>
          </div>
          
          <!-- Inputs ocultos para archivos -->
          <input type="file" id="imagenInput" class="file-input" accept="image/*" onchange="enviarArchivo(this, 'imagen')">
          <input type="file" id="videoInput" class="file-input" accept="video/*" onchange="enviarArchivo(this, 'video')">
          <input type="file" id="archivoInput" class="file-input" onchange="enviarArchivo(this, 'archivo')">
          
          <!-- Formulario de mensaje de texto -->
          <form id="formEnviarMensaje" th:action="@{/chat/enviar}" method="post">
            <input type="hidden" name="conversacionId" th:value="${conversacion.id}">
            <div class="input-group">
              <input type="text" 
                     class="form-control" 
                     name="contenido"
                     id="mensajeInput"
                     placeholder="Escribe un mensaje..." 
                     required
                     autocomplete="off">
              <button class="btn btn-send" type="submit">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </form>
        </div>
        
      </div>
      
    </div>
  </main>
  
  <!-- Modal Enviar Propuesta (Solo Entrenadores) -->
  <div class="modal fade" id="modalEnviarPropuesta" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-secondary">
          <h5 class="modal-title fw-bold">Enviar Propuesta de Plan</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form th:action="@{/negociacion/enviar-propuesta}" method="post">
          <input type="hidden" name="usuarioId" th:value="${conversacion.usuario.id}">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Seleccionar Plan Base</label>
              <select class="form-select bg-dark text-white border-secondary" name="planId" id="planSelect" required>
                <option value="">-- Selecciona un plan --</option>
                <option th:each="plan : ${planesEntrenador}" 
                        th:value="${plan.id}"
                        th:attr="data-precio=${plan.precioMensual}, data-duracion=${plan.duracionDias}, data-nombre=${plan.nombre}"
                        th:text="${plan.nombre} + ' - $' + ${#numbers.formatDecimal(plan.precioMensual, 0, 'COMMA', 0, 'POINT')} + ' COP'">
                </option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Precio Final (COP)</label>
              <input type="number" class="form-control bg-dark text-white border-secondary" 
                     name="precioFinal" id="precioFinalInput" required min="0">
              <small class="text-muted-flowfit">Puedes ajustar el precio seg칰n la negociaci칩n</small>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Duraci칩n (d칤as)</label>
              <input type="number" class="form-control bg-dark text-white border-secondary" 
                     name="duracionDias" id="duracionInput" value="30" required min="1">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Comentarios Adicionales</label>
              <textarea class="form-control bg-dark text-white border-secondary" 
                        name="comentarios" rows="3" 
                        placeholder="Agrega detalles sobre esta propuesta..."></textarea>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send me-2"></i>Enviar Propuesta
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Modal Contraoferta -->
  <div class="modal fade" id="modalContraoferta" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header border-secondary">
          <h5 class="modal-title fw-bold">Hacer Contraoferta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="formContraoferta" th:action="@{/negociacion/responder}" method="post">
          <input type="hidden" name="contratacionId" id="contraofertaContratacionId">
          <input type="hidden" name="accion" value="CONTRAOFERTA">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nuevo Precio (COP)</label>
              <input type="number" class="form-control bg-dark text-white border-secondary" 
                     name="precioFinal" required min="0">
            </div>
            <div class="mb-3">
              <label class="form-label">Comentarios</label>
              <textarea class="form-control bg-dark text-white border-secondary" 
                        name="comentarios" rows="3" 
                        placeholder="Explica tu contraoferta..."></textarea>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-warning">
              <i class="bi bi-arrow-repeat me-2"></i>Enviar Contraoferta
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- SockJS y STOMP para WebSocket -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  
  <!-- FlowFit Common JS -->
  <script th:src="@{/js/sidebar-common.js}"></script>
  
  <script>
    // Variables globales
    const conversacionId = [[${conversacion.id}]];
    const usuarioId = [[${usuario.id}]];
    const esUsuario = [[${esUsuario}]];
    let stompClient = null;
    
    // Auto-scroll al 칰ltimo mensaje
    function scrollToBottom() {
      const container = document.getElementById('mensajesContainer');
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    }
    
    // Scroll al cargar
    document.addEventListener('DOMContentLoaded', function() {
      scrollToBottom();
      conectarWebSocket();
    });
    
    // Conectar WebSocket
    function conectarWebSocket() {
      const socket = new SockJS('/ws-chat');
      stompClient = Stomp.over(socket);
      
      stompClient.connect({}, function(frame) {
        console.log('Conectado a WebSocket: ' + frame);
        
        // Suscribirse a mensajes de esta conversaci칩n
        stompClient.subscribe('/topic/conversacion/' + conversacionId, function(mensaje) {
          const data = JSON.parse(mensaje.body);
          agregarMensajeAlDOM(data);
        });
      }, function(error) {
        console.error('Error WebSocket:', error);
        // Reintentar conexi칩n despu칠s de 5 segundos
        setTimeout(conectarWebSocket, 5000);
      });
    }
    
    // Agregar mensaje al DOM en tiempo real
    function agregarMensajeAlDOM(data) {
      const container = document.getElementById('mensajesContainer');
      const esEnviado = data.remitenteId === usuarioId;
      
      const mensajeHTML = `
        <div class="mensaje-item ${esEnviado ? 'enviado' : 'recibido'}">
          <div class="mensaje-bubble">
            <p class="mb-1 text-white">${escapeHtml(data.contenido)}</p>
            <small class="text-muted-flowfit" style="font-size: 0.75rem;">
              ${formatearHora(data.fechaEnvio)}
            </small>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', mensajeHTML);
      scrollToBottom();
    }
    
    // Formatear hora
    function formatearHora(fechaStr) {
      const fecha = new Date(fechaStr);
      return fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Escapar HTML para prevenir XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Ya NO necesitamos auto-refresh porque tenemos WebSocket
    // setInterval(() => { location.reload(); }, 10000); // ELIMINADO
    
    // Actualizar precio cuando se selecciona un plan
    document.getElementById('planSelect')?.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      const precio = selected.getAttribute('data-precio');
      const duracion = selected.getAttribute('data-duracion');
      
      document.getElementById('precioFinalInput').value = precio;
      document.getElementById('duracionInput').value = duracion;
    });
    
    // Aceptar propuesta
    function aceptarPropuesta(button) {
      const contratacionId = button.getAttribute('data-contratacion-id');
      if (confirm('쮼st치s seguro de aceptar esta propuesta? Se proceder치 al pago.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/negociacion/responder';
        
        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = 'contratacionId';
        inputId.value = contratacionId;
        form.appendChild(inputId);
        
        const inputAccion = document.createElement('input');
        inputAccion.type = 'hidden';
        inputAccion.name = 'accion';
        inputAccion.value = 'ACEPTAR';
        form.appendChild(inputAccion);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    // Rechazar propuesta
    function rechazarPropuesta(button) {
      const contratacionId = button.getAttribute('data-contratacion-id');
      if (confirm('쮼st치s seguro de rechazar esta propuesta?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/negociacion/responder';
        
        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = 'contratacionId';
        inputId.value = contratacionId;
        form.appendChild(inputId);
        
        const inputAccion = document.createElement('input');
        inputAccion.type = 'hidden';
        inputAccion.name = 'accion';
        inputAccion.value = 'RECHAZAR';
        form.appendChild(inputAccion);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    // Preparar contraoferta
    document.querySelectorAll('[data-bs-target="#modalContraoferta"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const contratacionId = this.getAttribute('data-contratacion-id');
        document.getElementById('contraofertaContratacionId').value = contratacionId;
      });
    });
    
    // Confirmar servicio (Escrow)
    function confirmarServicio(button) {
      const pagoId = button.getAttribute('data-pago-id');
      if (confirm('쮺onfirmas que has recibido/entregado el servicio correctamente?')) {
        const esUsuario = [[${esUsuario}]];
        const endpoint = esUsuario ? '/negociacion/confirmar-servicio/usuario' : '/negociacion/confirmar-servicio/entrenador';
        
        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ pagoId: pagoId })
        })
        .then(response => response.json())
        .then(data => {
          alert(data.mensaje || 'Confirmaci칩n registrada');
          location.reload();
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al confirmar el servicio');
        });
      }
    }
    
    // Focus en input al cargar
    document.getElementById('mensajeInput')?.focus();
    
    // Manejar env칤o de mensaje con AJAX
    document.getElementById('formEnviarMensaje')?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const mensajeInput = document.getElementById('mensajeInput');
      
      // Deshabilitar bot칩n mientras se env칤a
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      
      fetch(this.action, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          mensajeInput.value = ''; // Limpiar input
          // NO recargar la p치gina - WebSocket se encarga de mostrar el mensaje
        } else {
          alert('Error al enviar mensaje: ' + (data.message || 'Error desconocido'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje');
      })
      .finally(() => {
        submitBtn.disabled = false;
        mensajeInput.focus();
      });
    });
    
    // Funci칩n para enviar archivos (placeholder - requiere implementaci칩n backend)
    function enviarArchivo(input, tipo) {
      const file = input.files[0];
      if (!file) return;
      
      // Validar tama침o (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('El archivo es demasiado grande. M치ximo 10MB.');
        input.value = '';
        return;
      }
      
      // Mostrar mensaje de "Subiendo..."
      const container = document.getElementById('mensajesContainer');
      const loadingHTML = `
        <div class="mensaje-item enviado" id="uploading-message">
          <div class="mensaje-bubble">
            <p class="mb-1 text-white">
              <i class="bi bi-arrow-repeat spin"></i> Subiendo ${tipo}...
            </p>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', loadingHTML);
      scrollToBottom();
      
      // TODO: Implementar upload de archivos al backend
      // Por ahora solo mostramos un mensaje simulado
      setTimeout(() => {
        document.getElementById('uploading-message')?.remove();
        const mensajeSimulado = {
          remitenteId: usuarioId,
          contenido: `游늹 ${file.name} (${(file.size / 1024).toFixed(1)} KB)`,
          fechaEnvio: new Date().toISOString()
        };
        agregarMensajeAlDOM(mensajeSimulado);
        input.value = ''; // Limpiar input
        
        alert('Funci칩n de subida de archivos pr칩ximamente. Por ahora solo texto.');
      }, 1500);
    }
  </script>
</body>
</html>
