<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa - FlowFit</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link th:href="@{/css/flowfit-base.css}" rel="stylesheet">
  <link th:href="@{/css/flowfit-usuario.css}" rel="stylesheet">
  <link th:href="@{/css/usuario-mapa.css}" rel="stylesheet">
</head>
<body class="flowfit-body usuario-body">

  <!-- Sidebar -->
  <div th:replace="fragments/sidebar-user :: sidebar"></div>
  <div class="flowfit-sidebar-overlay d-lg-none" id="sidebarOverlay"></div>
  <button class="flowfit-sidebar-toggle sidebar-toggle-usuario d-lg-none" id="sidebarToggle">
    <i class="bi bi-list"></i>
  </button>

  <!-- Navigation -->
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a th:href="@{/usuario/dashboard}" class="nav-link-base nav-link-usuario">
          <i class="bi bi-speedometer2 me-3"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/usuario/rutinas}" class="nav-link-base nav-link-usuario">
          <i class="bi bi-list-check me-3"></i> Mis Rutinas
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/usuario/buscar-entrenador}" class="nav-link-base nav-link-usuario">
          <i class="bi bi-person-plus me-3"></i> Mi Entrenador
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/usuario/progreso}" class="nav-link-base nav-link-usuario active">
          <i class="bi bi-graph-up me-3"></i> Mi Progreso
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/usuario/mapa}" class="nav-link-base nav-link-usuario">
          <i class="bi bi-geo-alt me-3"></i> Mapa
        </a>
      </li>
      <li class="nav-item">
        <a th:href="@{/usuario/perfil}" class="nav-link-base nav-link-usuario">
          <i class="bi bi-person-circle me-3"></i> Mi Perfil
        </a>
      </li>
    </ul>

 <!-- Profile Section -->
    <div class="border-top pt-3 mt-auto">
      <div class="dropdown profile-dropdown-base">
        <div class="profile-icon-base d-flex align-items-center w-100" id="profileDropdownUsuario" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="/assets/perfil_default.png" alt="Profile" class="profile-image-base me-2" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
          <div class="flex-grow-1">
            <div class="small fw-bold text-white" th:text="${usuario != null ? #strings.substringBefore(usuario.nombre, ' ') : 'Usuario'}">Usuario</div>
            <div class="small text-muted-flowfit">FlowFit</div>
          </div>
          <i class="bi bi-chevron-down text-white"></i>
        </div>
        <ul class="dropdown-menu" aria-labelledby="profileDropdownUsuario">
          <li><a class="dropdown-item" th:href="@{/usuario/perfil}"><i class="bi bi-person-gear me-2"></i>Mi Perfil</a></li>
          <li><a class="dropdown-item" th:href="@{/usuario/configuracion}"><i class="bi bi-gear me-2"></i>Configuración</a></li>
          <li><a class="dropdown-item" th:href="@{/usuario/soporte}"><i class="bi bi-headset me-2"></i>Soporte</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" th:href="@{/logout}"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <main class="main-content-base fade-in-up">
    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-12">
          <div class="flowfit-page-header">
            <div class="flowfit-page-title">
              <h1 class="flowfit-title"><i class="bi bi-geo-alt me-2"></i>Mapa</h1>
              <p class="flowfit-subtitle">Ubicación y puntos de interés</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="flowfit-card card-usuario">
            <div class="card-header">
              <h5 class="card-title mb-0 text-white"><i class="bi bi-map me-2"></i>Mapa</h5>
            </div>
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script th:src="@{/js/usuario-mapa.js}"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDaeWicvigtP9xPv919E-RNoxfvC-Hqik&libraries=places&v=weekly&callback=iniciarMap" async defer></script>
  <!-- Leaflet (fallback si Google Maps no responde) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+4g3o7wqv1z7Zqk3gYh6b0gk2Xc8HkG6v9YlP5R0M=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-Vt6v7Y6m3yqTeKc3Nf0vYq0Q1s5dYt1K8lM8Yw5gk8M=" crossorigin=""></script>

  <script>
    // Si Google Maps no llama a iniciarMap en 8s, cargamos Leaflet como fallback
    (function(){
      var timeout = setTimeout(function(){
        if(!(window.google && window.google.maps && window.google.maps.Map)){
          console.warn('Google Maps no cargó, usando Leaflet como fallback.');
          // Inicializar mapa Leaflet
          var mapEl = document.getElementById('map');
          if(mapEl){
            // Limpiar contenido previo
            mapEl.innerHTML = '';
            mapEl.style.height = mapEl.style.height || '500px';
            var map = L.map('map').setView([4.6518757, -74.0629621], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            L.marker([4.6518757, -74.0629621]).addTo(map).bindPopup('Ubicación por defecto').openPopup();
          }
        }
      }, 8000);

      // Si Google llama a iniciarMap cancelamos el timeout
      var orig = window.iniciarMap;
      window.iniciarMap = function(){
        clearTimeout(timeout);
        if(typeof orig === 'function') orig();
      }
    })();
  </script>
  <!-- Sidebar shared scripts -->
  <script th:src="@{/js/sidebar-common.js}"></script>
  <script src="/js/sidebar-profile.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>